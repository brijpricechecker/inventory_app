<!DOCTYPE html>
<html>
<head>
  <title>Inventory & Purchase Order</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    select, input[type="number"] { width: 100%; padding: 5px; }
    button { padding: 10px 15px; margin-top: 20px; }
  </style>
</head>
<body>

<h2>Inventory and Purchase Order</h2>

<label for="supplierFilter">Filter by Supplier:</label>
<select id="supplierFilter" multiple></select>
<br>

<table id="inventoryTable">
  <thead>
    <tr>
      <th>Barcode</th>
      <th>Item Name</th>
      <th>Supplier</th>
      <th>Alt Supplier</th>
      <th>Purchase Price</th>
      <th>Alt PP</th>
      <th>Total Sold</th>
      <th>Current Inventory</th>
      <th>Order Qty</th>
      <th>Use Alt?</th>
      <th>Amount</th>
      <th>Include?</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button onclick="submitOrders()">Submit Orders</button>
<button onclick="downloadCSV()">Download CSV</button>

<p>Web App URL: <a href="https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec" target="_blank">Open App</a></p>

<script>
let inventoryData = [];

function fetchData() {
  const supplierFilter = document.getElementById("supplierFilter");
  const selected = Array.from(supplierFilter.selectedOptions).map(opt => opt.value);
  const param = selected.length ? `?suppliers=${selected.join(',')}` : '';
  fetch("/exec" + param)
    .then(res => res.json())
    .then(data => {
      inventoryData = data;
      populateTable(data);
      populateSuppliers(data);
    });
}

function populateSuppliers(data) {
  const filter = document.getElementById("supplierFilter");
  const uniqueSuppliers = [...new Set(data.map(d => d.supplier))].filter(Boolean);
  filter.innerHTML = uniqueSuppliers.map(s => `<option value="${s}">${s}</option>`).join('');
}

function populateTable(data) {
  const tbody = document.querySelector("#inventoryTable tbody");
  tbody.innerHTML = "";
  data.forEach((item, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${item.barcode}</td>
        <td>${item.name}</td>
        <td>${item.supplier}</td>
        <td>${item.altSupplier}</td>
        <td>${item.purchasePrice}</td>
        <td>${item.altPP}</td>
        <td>${item.totalSold}</td>
        <td>${item.currentInventory}</td>
        <td><input type="number" min="0" data-idx="${i}" class="orderQty"></td>
        <td><input type="checkbox" data-idx="${i}" class="useAlt"></td>
        <td class="amount">0</td>
        <td><input type="checkbox" class="includeOrder" data-idx="${i}" checked></td>
      </tr>
    `;
  });
  document.querySelectorAll('.orderQty, .useAlt').forEach(el => {
    el.addEventListener('input', updateAmounts);
    el.addEventListener('change', updateAmounts);
  });
}

function updateAmounts() {
  document.querySelectorAll("#inventoryTable tbody tr").forEach((row, i) => {
    const qty = Number(row.querySelector(".orderQty").value || 0);
    const useAlt = row.querySelector(".useAlt").checked;
    const item = inventoryData[i];
    const unitPrice = useAlt && item.altPP ? parseFloat(item.altPP) : parseFloat(item.purchasePrice);
    const amount = qty * (unitPrice || 0);
    row.querySelector(".amount").innerText = amount.toFixed(2);
  });
}

function submitOrders() {
  const orders = [];
  document.querySelectorAll("#inventoryTable tbody tr").forEach((row, i) => {
    const include = row.querySelector(".includeOrder").checked;
    if (!include) return;
    const qty = Number(row.querySelector(".orderQty").value || 0);
    if (!qty) return;
    const item = inventoryData[i];
    const useAlt = row.querySelector(".useAlt").checked;
    const unitPrice = useAlt && item.altPP ? parseFloat(item.altPP) : parseFloat(item.purchasePrice);
    const supplier = useAlt && item.altSupplier ? item.altSupplier : item.supplier;
    const amount = qty * unitPrice;
    orders.push({
      barcode: item.barcode,
      name: item.name,
      supplier,
      orderQty: qty,
      unitPrice,
      amount: parseFloat(amount.toFixed(2))
    });
  });

  fetch("/exec", {
    method: "POST",
    body: JSON.stringify({ orders }),
    headers: { "Content-Type": "application/json" }
  })
  .then(res => res.json())
  .then(res => {
    if (res.success) alert("Orders submitted to Google Sheet.");
  });
}

function downloadCSV() {
  const rows = [
    ["Barcode", "Item Name", "Supplier", "Order Qty", "Unit Price", "Amount"]
  ];
  document.querySelectorAll("#inventoryTable tbody tr").forEach((row, i) => {
    const include = row.querySelector(".includeOrder").checked;
    if (!include) return;
    const qty = Number(row.querySelector(".orderQty").value || 0);
    if (!qty) return;
    const item = inventoryData[i];
    const useAlt = row.querySelector(".useAlt").checked;
    const unitPrice = useAlt && item.altPP ? parseFloat(item.altPP) : parseFloat(item.purchasePrice);
    const supplier = useAlt && item.altSupplier ? item.altSupplier : item.supplier;
    const amount = qty * unitPrice;
    rows.push([
      item.barcode, item.name, supplier, qty, unitPrice, amount.toFixed(2)
    ]);
  });
  const csv = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], { type: 'text/csv' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'purchase_orders.csv';
  link.click();
}

document.getElementById("supplierFilter").addEventListener("change", fetchData);
window.onload = fetchData;
</script>

</body>
</html>
