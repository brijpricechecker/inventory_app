<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventory & Purchase Order</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th.sortable:hover { cursor: pointer; background-color: #f0f0f0; }
    .zero-inventory { background-color: #ffe5e5; }
    .filter-group { margin-bottom: 10px; display: flex; align-items: center; gap: 15px; }
    .checkbox-popup {
      border: 1px solid #ccc;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      position: absolute;
      background: white;
      z-index: 10;
      display: none;
    }
    .checkbox-popup label { display: block; margin-top: 5px; }
    .total-order { font-weight: bold; margin-top: 10px; }
    button { margin-right: 10px; padding: 6px 12px; }
    .mode-button.active { font-weight: bold; background-color: #007bff; color: white; border: none; }
    .mode-button { border: 1px solid #ccc; background: #f9f9f9; }
  </style>
</head>
<body>

  <h1>Inventory & Purchase Order</h1>

  <div class="filter-group">
    <div>
      <button id="inventoryBtn" class="mode-button active">Inventory</button>
      <button id="poBtn" class="mode-button">Purchase Order</button>
    </div>

    <div style="position: relative;">
      <button id="supplierFilterBtn">Filter Suppliers</button>
      <div id="supplierList" class="checkbox-popup"></div>
    </div>

    <button onclick="exportCSV()">Export CSV</button>
  </div>

  <div class="total-order" id="totalOrder" style="display: none;"></div>

  <table id="dataTable">
    <thead>
      <tr id="tableHead"></tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    let items = [];
    let selectedSuppliers = [];
    let allSuppliers = [];
    let currentMode = 'inventory';
    let inventorySortAsc = true;

    document.getElementById('inventoryBtn').addEventListener('click', () => {
      currentMode = 'inventory';
      updateModeButtons();
      fetchData();
    });

    document.getElementById('poBtn').addEventListener('click', () => {
      currentMode = 'po';
      updateModeButtons();
      fetchData();
    });

    function updateModeButtons() {
      document.getElementById('inventoryBtn').classList.toggle('active', currentMode === 'inventory');
      document.getElementById('poBtn').classList.toggle('active', currentMode === 'po');
    }

    document.getElementById('supplierFilterBtn').addEventListener('click', () => {
      const popup = document.getElementById('supplierList');
      popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
    });

    function fetchData() {
      const params = new URLSearchParams();
      params.append('mode', currentMode);
      if (selectedSuppliers.length) {
        params.append('suppliers', selectedSuppliers.join(','));
      }

      fetch(`https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
          items = data.items;
          allSuppliers = data.suppliers;
          if (!selectedSuppliers.length) selectedSuppliers = [...allSuppliers];
          renderSupplierDropdown();
          renderTable();
        });
    }

    function renderSupplierDropdown() {
      const container = document.getElementById('supplierList');
      container.innerHTML = '';

      const allBox = document.createElement('input');
      allBox.type = 'checkbox';
      allBox.id = 'selectAllSuppliers';
      allBox.checked = selectedSuppliers.length === allSuppliers.length;
      allBox.onchange = () => {
        selectedSuppliers = allBox.checked ? [...allSuppliers] : [];
        fetchData();
        container.style.display = 'none';
      };
      container.appendChild(allBox);
      container.appendChild(document.createTextNode(' Select All'));

      allSuppliers.forEach(supplier => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = supplier;
        checkbox.checked = selectedSuppliers.includes(supplier);
        checkbox.onchange = () => {
          if (checkbox.checked) {
            if (!selectedSuppliers.includes(supplier)) selectedSuppliers.push(supplier);
          } else {
            selectedSuppliers = selectedSuppliers.filter(s => s !== supplier);
          }
          document.getElementById('selectAllSuppliers').checked = selectedSuppliers.length === allSuppliers.length;
          fetchData();
          container.style.display = 'none';
        };
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(' ' + supplier));
        container.appendChild(label);
      });
    }

    function renderTable() {
      const headRow = document.getElementById('tableHead');
      const body = document.getElementById('tableBody');
      headRow.innerHTML = '';
      body.innerHTML = '';

      const headers = ['Barcode', 'Item Name', 'Supplier', 'Purchase Price', 'Current Inventory'];
      if (currentMode === 'po') {
        headers.push('Order Quantity', 'Order Amount');
      }

      headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;

        if (header === 'Current Inventory') {
          th.classList.add('sortable');
          th.innerHTML += ` <span style="font-size: 12px;">&#x21C5;</span>`;
          th.addEventListener('click', () => {
            inventorySortAsc = !inventorySortAsc;
            items.sort((a, b) => inventorySortAsc ? a.currentInventory - b.currentInventory : b.currentInventory - a.currentInventory);
            renderTable();
          });
        }

        headRow.appendChild(th);
      });

      let totalOrder = 0;

      items.forEach(item => {
        const row = document.createElement('tr');
        if (item.currentInventory === 0) row.classList.add('zero-inventory');

        const orderQtyInput = document.createElement('input');
        orderQtyInput.type = 'number';
        orderQtyInput.min = '0';
        orderQtyInput.style.width = '80px';
        orderQtyInput.value = item.qty || '';
        orderQtyInput.addEventListener('input', (e) => {
          item.qty = +e.target.value || 0;
          item.amount = item.qty * (item.purchasePrice || 0);
          renderTable();
        });

        const orderAmount = item.qty ? (item.qty * item.purchasePrice).toFixed(2) : '';

        const cols = [
          item.barcode,
          item.name,
          item.supplier1,
          item.purchasePrice.toFixed(2),
          item.currentInventory
        ];

        if (currentMode === 'po') {
          cols.push(orderQtyInput, orderAmount ? `₱${orderAmount}` : '');
          totalOrder += item.qty ? item.qty * item.purchasePrice : 0;
        }

        cols.forEach(col => {
          const td = document.createElement('td');
          if (col instanceof HTMLElement) {
            td.appendChild(col);
          } else {
            td.innerHTML = col;
          }
          row.appendChild(td);
        });

        body.appendChild(row);
      });

      const totalOrderDiv = document.getElementById('totalOrder');
      if (currentMode === 'po') {
        totalOrderDiv.textContent = `Total Order Amount: ₱${totalOrder.toFixed(2)}`;
        totalOrderDiv.style.display = 'block';
      } else {
        totalOrderDiv.style.display = 'none';
      }
    }

    function exportCSV() {
      const now = new Date();
      const pad = n => n.toString().padStart(2, '0');
      const ts = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`;
      const supplierName = selectedSuppliers.length === 1 ? selectedSuppliers[0].replace(/\s+/g, '_') : 'multiple';
      const modeLabel = currentMode === 'po' ? 'purchase_order' : 'inventory';
      const filename = `${modeLabel}_${supplierName}_${ts}.csv`;

      const headers = ['Barcode', 'Item Name', 'Supplier', 'Purchase Price', 'Current Inventory'];
      if (currentMode === 'po') headers.push('Order Quantity', 'Order Amount');

      const rows = [headers];

      items.forEach(item => {
        if (currentMode === 'po' && (!item.qty || item.qty <= 0)) return;

        const row = [
          item.barcode,
          item.name,
          item.supplier1,
          item.purchasePrice.toFixed(2),
          item.currentInventory
        ];

        if (currentMode === 'po') {
          row.push(item.qty || 0, (item.qty * item.purchasePrice).toFixed(2));
        }

        rows.push(row);
      });

      const csvContent = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.click();
      URL.revokeObjectURL(url);
    }

    fetchData();
  </script>
</body>
</html>
