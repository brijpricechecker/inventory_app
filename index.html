<!DOCTYPE html>
<html>
<head>
  <title>Inventory & Purchase Order</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
    .left-controls, .right-controls { display: flex; align-items: center; gap: 10px; }
    .highlight-zero { background-color: #ffe5e5; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    #totalAmountCell { font-weight: bold; margin-top: 10px; }
    .hidden { display: none; }
  </style>
</head>
<body>

<div class="controls">
  <div class="left-controls">
    <button onclick="switchToInventory()">Inventory</button>
    <button onclick="switchToPO()">Purchase Order</button>
    <button onclick="toggleAltSupplier()" id="altBtn" class="hidden">Use Alt Supplier</button>
    <div id="supplierFilter"></div>
    <button onclick="submitOrders()" id="submitBtn" class="hidden">Submit Orders</button>
    <button onclick="downloadCSV()" id="csvBtn" class="hidden">Download CSV</button>
  </div>
  <div class="right-controls">
    <input type="text" id="searchBar" placeholder="Search by name or barcode" onkeyup="renderTable()">
  </div>
</div>

<div id="totalAmountCell" class="hidden">Total Order Amount: PHP 0.00</div>

<table>
  <thead>
    <tr id="tableHeaders"></tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
  const apiUrl = 'https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec';
  let allItems = [], filteredItems = [];
  let selectedSuppliers = [], useAlt = false;
  let isPO = false;

  async function fetchData() {
    const res = await fetch(apiUrl);
    const data = await res.json();
    allItems = data.allItems;
    filteredItems = data.items;
    selectedSuppliers = [...data.suppliers];
    setupSupplierFilter(data.suppliers);
    renderTable();
  }

  function setupSupplierFilter(suppliers) {
    const container = document.getElementById('supplierFilter');
    container.innerHTML = '';
    const dropdown = document.createElement('select');
    dropdown.multiple = true;
    dropdown.size = Math.min(suppliers.length + 1, 8);

    suppliers.forEach(supplier => {
      const option = document.createElement('option');
      option.value = supplier;
      option.text = supplier;
      option.selected = true;
      dropdown.appendChild(option);
    });

    dropdown.onchange = () => {
      selectedSuppliers = Array.from(dropdown.selectedOptions).map(opt => opt.value);
      renderTable();
    };

    container.appendChild(dropdown);
  }

  function switchToPO() {
    isPO = true;
    document.getElementById('altBtn').classList.remove('hidden');
    document.getElementById('submitBtn').classList.remove('hidden');
    document.getElementById('csvBtn').classList.remove('hidden');
    document.getElementById('totalAmountCell').classList.remove('hidden');
    renderTable();
  }

  function switchToInventory() {
    isPO = false;
    document.getElementById('altBtn').classList.add('hidden');
    document.getElementById('submitBtn').classList.add('hidden');
    document.getElementById('csvBtn').classList.add('hidden');
    document.getElementById('totalAmountCell').classList.add('hidden');
    renderTable();
  }

  function toggleAltSupplier() {
    useAlt = !useAlt;
    renderTable();
  }

  function renderTable() {
    const items = isPO ? allItems : filteredItems;
    const query = document.getElementById('searchBar').value.toLowerCase();
    const tbody = document.getElementById('tableBody');
    const thead = document.getElementById('tableHeaders');
    tbody.innerHTML = '';
    thead.innerHTML = '';

    // Build headers
    const baseHeaders = ['Barcode', 'Item Name', 'Current Inventory', 'Supplier', 'Purchase Price'];
    if (isPO) {
      baseHeaders.push('Order Quantity', 'Order Amount');
    } else {
      baseHeaders.push('Inventory Amount');
    }
    baseHeaders.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      thead.appendChild(th);
    });

    let total = 0;

    items.forEach(item => {
      if (!selectedSuppliers.includes(item.supplier1)) return;
      if (query &&
        !item.name.toLowerCase().includes(query) &&
        !item.barcode.toLowerCase().includes(query)) return;

      const supplier = useAlt ? (item.supplier2 || item.supplier1) : item.supplier1;
      const price = useAlt ? (item.altPurchasePrice || item.purchasePrice) : item.purchasePrice;
      const tr = document.createElement('tr');
      if (item.currentInventory === 0) tr.classList.add('highlight-zero');

      const cells = [
        item.barcode,
        item.name,
        item.currentInventory,
        supplier,
        price.toFixed(2)
      ];

      if (isPO) {
        cells.push(`<input type="number" min="0" value="0" onchange="updateAmount(this)">`);
        cells.push(`<span class="amount">0.00</span>`);
      } else {
        cells.push((item.currentInventory * price).toFixed(2));
      }

      tr.innerHTML = cells.map(c => `<td>${c}</td>`).join('');
      tbody.appendChild(tr);
    });

    updateTotalAmount();
  }

  function updateAmount(input) {
    const row = input.closest('tr');
    const price = parseFloat(row.children[4].textContent);
    const qty = parseInt(input.value) || 0;
    const amount = price * qty;
    row.querySelector('.amount').textContent = amount.toFixed(2);
    updateTotalAmount();
  }

  function updateTotalAmount() {
    let total = 0;
    document.querySelectorAll('.amount').forEach(el => {
      total += parseFloat(el.textContent);
    });
    document.getElementById('totalAmountCell').textContent = `Total Order Amount: PHP ${total.toFixed(2)}`;
  }

  function submitOrders() {
    const orders = [];
    document.querySelectorAll('#tableBody tr').forEach(row => {
      const qtyInput = row.children[5]?.querySelector('input');
      if (qtyInput) {
        const qty = parseInt(qtyInput.value);
        if (qty > 0) {
          orders.push({
            barcode: row.children[0].textContent,
            name: row.children[1].textContent,
            supplier: row.children[3].textContent,
            qty,
            amount: parseFloat(row.children[6].textContent)
          });
        }
      }
    });
    if (orders.length === 0) return alert('No orders to submit.');
    google.script.run.savePurchaseOrders(orders);
    alert('Orders submitted successfully!');
  }

  function downloadCSV() {
    const rows = [['Date', 'Barcode', 'Item Name', '', 'Supplier', 'Purchase Price', 'Order Quantity', 'Total Order Amount']];
    const now = new Date();
    const timestamp = `${now.getMonth() + 1}/${now.getDate()}/${now.getFullYear()} ${now.toLocaleTimeString('en-US', { hour12: false })}`;
    let supplierForFile = selectedSuppliers.length === 1 ? selectedSuppliers[0] : 'Multiple';
    let filename = `PO_${supplierForFile}_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${now.getHours()}-${now.getMinutes()}.csv`;

    document.querySelectorAll('#tableBody tr').forEach(row => {
      const cells = row.querySelectorAll('td');
      const qtyInput = cells[5]?.querySelector('input');
      if (qtyInput) {
        const qty = Number(qtyInput.value);
        const price = parseFloat(cells[4].textContent);
        const total = qty * price;
        if (qty > 0) {
          rows.push([
            timestamp,
            `="${cells[0].textContent}"`,
            cells[1].textContent,
            '',
            cells[3].textContent,
            price.toFixed(2),
            qty,
            total.toFixed(2)
          ]);
        }
      }
    });

    const csvContent = rows.map(e => e.join(",")).join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.setAttribute('href', URL.createObjectURL(blob));
    link.setAttribute('download', filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  fetchData();
</script>
</body>
</html>
