<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventory & Purchase Order</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th.sortable:hover { cursor: pointer; background-color: #f0f0f0; }
    .zero-inventory { background-color: #ffe5e5; }
    .filter-group { margin-bottom: 10px; }
    .checkbox-popup { border: 1px solid #ccc; padding: 10px; max-height: 200px; overflow-y: auto; position: absolute; background: white; z-index: 10; display: none; }
    .total-order { font-weight: bold; margin-top: 10px; }
    .button-row { margin-top: 10px; }
    button { margin-right: 10px; padding: 6px 12px; }
  </style>
</head>
<body>

  <h1>Inventory & Purchase Order</h1>

  <div class="filter-group">
    <label for="mode">Mode:</label>
    <select id="mode">
      <option value="inventory">Inventory</option>
      <option value="po">Purchase Order</option>
    </select>

    <div style="display: inline-block; position: relative;">
      <button id="supplierFilterBtn">Filter Suppliers</button>
      <div id="supplierPopup" class="checkbox-popup"></div>
    </div>

    <div class="button-row">
      <button onclick="exportCSV()">Export CSV</button>
    </div>
  </div>

  <div class="total-order" id="totalOrder" style="display: none;"></div>

  <table id="dataTable">
    <thead>
      <tr id="tableHead"></tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    let items = [];
    let selectedSuppliers = [];
    let allSuppliers = [];
    let currentMode = 'inventory';
    let inventorySortAsc = true;

    document.getElementById('mode').addEventListener('change', () => {
      currentMode = document.getElementById('mode').value;
      fetchData();
    });

    document.getElementById('supplierFilterBtn').addEventListener('click', () => {
      const popup = document.getElementById('supplierPopup');
      popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
    });

    function fetchData() {
      const params = new URLSearchParams();
      params.append('mode', currentMode);
      if (selectedSuppliers.length) {
        params.append('suppliers', selectedSuppliers.join(','));
      }

      fetch(`https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
          items = data.items;
          allSuppliers = data.suppliers;
          if (!selectedSuppliers.length) selectedSuppliers = [...allSuppliers];
          renderSupplierPopup();
          renderTable();
        });
    }

    function renderSupplierPopup() {
      const popup = document.getElementById('supplierPopup');
      popup.innerHTML = '';
      const selectAll = document.createElement('div');
      const allChecked = selectedSuppliers.length === allSuppliers.length;
      selectAll.innerHTML = `<label><input type="checkbox" id="selectAll" ${allChecked ? 'checked' : ''}/> Select All</label>`;
      popup.appendChild(selectAll);

      document.getElementById('selectAll').addEventListener('change', (e) => {
        if (e.target.checked) {
          selectedSuppliers = [...allSuppliers];
        } else {
          selectedSuppliers = [];
        }
        fetchData();
      });

      allSuppliers.forEach(supplier => {
        const checkbox = document.createElement('div');
        checkbox.innerHTML = `<label><input type="checkbox" value="${supplier}" ${selectedSuppliers.includes(supplier) ? 'checked' : ''}/> ${supplier}</label>`;
        popup.appendChild(checkbox);

        checkbox.querySelector('input').addEventListener('change', (e) => {
          if (e.target.checked) {
            selectedSuppliers.push(supplier);
          } else {
            selectedSuppliers = selectedSuppliers.filter(s => s !== supplier);
          }
          fetchData();
        });
      });
    }

    function renderTable() {
      const headRow = document.getElementById('tableHead');
      const body = document.getElementById('tableBody');
      headRow.innerHTML = '';
      body.innerHTML = '';

      const headers = ['Barcode', 'Item Name', 'Supplier', 'Purchase Price', 'Current Inventory'];
      if (currentMode === 'po') {
        headers.push('Order Quantity', 'Order Amount');
      }

      headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;

        if (header === 'Current Inventory') {
          th.classList.add('sortable');
          th.innerHTML += ` <span style="font-size: 12px;">&#x21C5;</span>`;
          th.addEventListener('click', () => {
            inventorySortAsc = !inventorySortAsc;
            items.sort((a, b) => inventorySortAsc ? a.currentInventory - b.currentInventory : b.currentInventory - a.currentInventory);
            renderTable();
          });
        }

        headRow.appendChild(th);
      });

      let totalOrder = 0;

      items.forEach(item => {
        const row = document.createElement('tr');
        if (item.currentInventory === 0) row.classList.add('zero-inventory');

        const orderQtyInput = document.createElement('input');
        orderQtyInput.type = 'number';
        orderQtyInput.min = '0';
        orderQtyInput.style.width = '80px';
        orderQtyInput.value = item.qty || '';
        orderQtyInput.addEventListener('input', (e) => {
          item.qty = +e.target.value || 0;
          item.amount = item.qty * (item.purchasePrice || 0);
          renderTable(); // Refresh to update order amount and total
        });

        const orderAmount = item.qty ? (item.qty * item.purchasePrice).toFixed(2) : '';

        const cols = [
          item.barcode,
          item.name,
          item.supplier1,
          item.purchasePrice.toFixed(2),
          item.currentInventory
        ];

        if (currentMode === 'po') {
          cols.push(orderQtyInput, orderAmount ? `₱${orderAmount}` : '');
          totalOrder += item.qty ? item.qty * item.purchasePrice : 0;
        }

        cols.forEach(col => {
          const td = document.createElement('td');
          if (col instanceof HTMLElement) {
            td.appendChild(col);
          } else {
            td.innerHTML = col;
          }
          row.appendChild(td);
        });

        body.appendChild(row);
      });

      const totalOrderDiv = document.getElementById('totalOrder');
      if (currentMode === 'po') {
        totalOrderDiv.textContent = `Total Order Amount: ₱${totalOrder.toFixed(2)}`;
        totalOrderDiv.style.display = 'block';
      } else {
        totalOrderDiv.style.display = 'none';
      }
    }

    function exportCSV() {
      const now = new Date();
      const pad = n => n.toString().padStart(2, '0');
      const ts = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`;
      const supplierName = selectedSuppliers.length === 1 ? selectedSuppliers[0].replace(/\s+/g, '_') : 'multiple';
      const modeLabel = currentMode === 'po' ? 'purchase_order' : 'inventory';
      const filename = `${modeLabel}_${supplierName}_${ts}.csv`;

      const headers = ['Barcode', 'Item Name', 'Supplier', 'Purchase Price', 'Current Inventory'];
      if (currentMode === 'po') headers.push('Order Quantity', 'Order Amount');

      const rows = [headers];

      items.forEach(item => {
        if (currentMode === 'po' && (!item.qty || item.qty <= 0)) return;

        const row = [
          item.barcode,
          item.name,
          item.supplier1,
          item.purchasePrice.toFixed(2),
          item.currentInventory
        ];

        if (currentMode === 'po') {
          row.push(item.qty || 0, (item.qty * item.purchasePrice).toFixed(2));
        }

        rows.push(row);
      });

      const csvContent = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.click();
      URL.revokeObjectURL(url);
    }

    // Initial fetch
    fetchData();
  </script>
</body>
</html>
