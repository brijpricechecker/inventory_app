<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Inventory / Purchase Order</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f0f0f0; }
    input[type="number"] { width: 60px; }
    .highlight { background-color: #dff0d8; }
    .mode-btn.active, #altToggle.active { background: #007bff; color: white; }
    .mode-btn, #altToggle {
      padding: 6px 12px; border: none; cursor: pointer;
      background: #e0e0e0; margin-right: 5px;
    }
    #controls { margin-bottom: 10px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }

    /* Supplier filter dropdown */
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: white;
      border: 1px solid #ccc;
      z-index: 1;
      max-height: 200px;
      overflow-y: auto;
      padding: 5px;
    }
    .dropdown:hover .dropdown-content {
      display: block;
    }
    .total-order {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Inventory / Purchase Order Dashboard</h2>

  <div id="controls">
    <button id="modeToggle" class="mode-btn">Switch to Purchase Order</button>
    <button id="altToggle" style="display:none;">Use Alt Supplier</button>

    <div class="dropdown">
      <button>Filter Suppliers â–¼</button>
      <div class="dropdown-content" id="supplierFilter"></div>
    </div>

    <button id="downloadBtn">Export to CSV</button>
    <button id="submitBtn" style="display:none;">Submit Order</button>
  </div>

  <div id="tableContainer"></div>
  <div id="totalOrder" class="total-order" style="display:none;"></div>

  <script>
    const apiUrl = 'https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec';
    let isPO = false;
    let useAlt = false;
    let allItems = [];
    let orderData = {};
    let selectedSuppliers = [];

    document.getElementById('modeToggle').onclick = toggleMode;
    document.getElementById('altToggle').onclick = toggleAltSupplier;
    document.getElementById('submitBtn').onclick = submitOrders;
    document.getElementById('downloadBtn').onclick = downloadCSV;

    function toggleMode() {
      isPO = !isPO;
      orderData = {};
      document.getElementById('modeToggle').textContent = isPO ? 'Switch to Inventory' : 'Switch to Purchase Order';
      document.getElementById('modeToggle').classList.toggle('active', isPO);
      document.getElementById('altToggle').style.display = isPO ? 'inline-block' : 'none';
      document.getElementById('submitBtn').style.display = isPO ? 'inline-block' : 'none';
      document.getElementById('totalOrder').style.display = isPO ? 'block' : 'none';
      fetchData();
    }

    function toggleAltSupplier() {
      useAlt = !useAlt;
      document.getElementById('altToggle').classList.toggle('active', useAlt);
      renderTable();
    }

    async function fetchData() {
      const suppliersParam = selectedSuppliers.map(s => encodeURIComponent(s)).join(',');
      const mode = isPO ? 'po' : 'inventory';
      const res = await fetch(`${apiUrl}?mode=${mode}&suppliers=${suppliersParam}`);
      const data = await res.json();
      allItems = data.items || [];
      if (!selectedSuppliers.length) selectedSuppliers = data.suppliers || [];
      populateSupplierFilter(data.suppliers || []);
      renderTable();
    }

    function populateSupplierFilter(suppliers) {
      const filter = document.getElementById('supplierFilter');
      filter.innerHTML = '';

      // "Select All" option
      const selectAll = document.createElement('div');
      const chkAll = document.createElement('input');
      chkAll.type = 'checkbox';
      chkAll.checked = selectedSuppliers.length === suppliers.length;
      chkAll.onchange = () => {
        selectedSuppliers = chkAll.checked ? [...suppliers] : [];
        populateSupplierFilter(suppliers);
        fetchData();
      };
      selectAll.appendChild(chkAll);
      selectAll.appendChild(document.createTextNode(' Select All'));
      filter.appendChild(selectAll);

      suppliers.forEach(supplier => {
        const div = document.createElement('div');
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.value = supplier;
        chk.checked = selectedSuppliers.includes(supplier);
        chk.onchange = () => {
          if (chk.checked) selectedSuppliers.push(supplier);
          else selectedSuppliers = selectedSuppliers.filter(s => s !== supplier);
          fetchData();
        };
        div.appendChild(chk);
        div.appendChild(document.createTextNode(' ' + supplier));
        filter.appendChild(div);
      });
    }

    function renderTable() {
      const container = document.getElementById('tableContainer');
      if (allItems.length === 0) {
        container.innerHTML = '<p>No data found.</p>';
        return;
      }

      let html = `<table><thead><tr>
        <th>Barcode</th><th>Item Name</th><th>Supplier</th><th>Purchase Price</th>`;

      if (isPO) html += `<th>Order Qty</th><th>Order Amount</th>`;
      else html += `<th>Inventory</th><th>Value</th>`;
      html += `</tr></thead><tbody>`;

      allItems.forEach(item => {
        const supplier = useAlt ? item.supplier2 : item.supplier1;
        const price = useAlt ? item.altPurchasePrice : item.purchasePrice;

        let row = `<tr${isPO && orderData[item.barcode] ? ' class="highlight"' : ''}>`;
        row += `<td>${item.barcode}</td>`;
        row += `<td>${item.name}</td>`;
        row += `<td>${supplier}</td>`;
        row += `<td>${price.toFixed(2)}</td>`;

        if (isPO) {
          const qty = orderData[item.barcode]?.qty || '';
          const amt = orderData[item.barcode]?.amount || 0;
          row += `<td><input type="number" min="0" value="${qty}" oninput="updateQty('${item.barcode}', this.value, ${price})" onfocus="this.select()"></td>`;
          row += `<td>${amt ? amt.toFixed(2) : ''}</td>`;
        } else {
          const inv = item.currentInventory || 0;
          row += `<td>${inv}</td>`;
          row += `<td>${(inv * price).toFixed(2)}</td>`;
        }

        row += `</tr>`;
        html += row;
      });

      html += `</tbody></table>`;
      container.innerHTML = html;
      updateTotal();
    }

    function updateQty(barcode, qty, price) {
      qty = parseInt(qty) || 0;
      if (qty > 0) {
        orderData[barcode] = {
          qty,
          amount: qty * price,
          barcode,
          name: allItems.find(i => i.barcode === barcode)?.name || '',
          supplier: useAlt
            ? allItems.find(i => i.barcode === barcode)?.supplier2 || ''
            : allItems.find(i => i.barcode === barcode)?.supplier1 || ''
        };
      } else {
        delete orderData[barcode];
      }
      renderTable();
    }

    function updateTotal() {
      if (!isPO) return;
      const total = Object.values(orderData).reduce((sum, o) => sum + o.amount, 0);
      document.getElementById('totalOrder').textContent = `Total Order Amount: PHP ${total.toFixed(2)}`;
    }

    async function submitOrders() {
      const payload = Object.values(orderData);
      if (!payload.length) return alert('No orders to submit.');
      await fetch(`${apiUrl}?action=save`, {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: { 'Content-Type': 'application/json' }
      });
      alert('Orders saved successfully.');
      orderData = {};
      fetchData();
    }

    function downloadCSV() {
      let csv = isPO
        ? 'Barcode,Item Name,Supplier,Quantity,Amount\n'
        : 'Barcode,Item Name,Supplier,Purchase Price,Inventory,Value\n';

      if (isPO) {
        Object.values(orderData).forEach(order => {
          csv += `"${order.barcode}","${order.name}","${order.supplier}",${order.qty},${order.amount}\n`;
        });
      } else {
        allItems.forEach(item => {
          const supplier = useAlt ? item.supplier2 : item.supplier1;
          const price = useAlt ? item.altPurchasePrice : item.purchasePrice;
          const inv = item.currentInventory || 0;
          const value = inv * price;
          csv += `"${item.barcode}","${item.name}","${supplier}",${price},${inv},${value.toFixed(2)}\n`;
        });
      }

      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = isPO ? 'purchase_orders.csv' : 'inventory.csv';
      link.click();
    }

    window.onload = fetchData;
  </script>
</body>
</html>
