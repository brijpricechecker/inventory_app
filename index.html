<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Inventory / Purchase Order</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f0f0f0; }
    input[type="number"] { width: 60px; }
    .highlight { background-color: #dff0d8; }
    .mode-btn.active, #altToggle.active { background: #007bff; color: white; }
    .mode-btn, #altToggle {
      padding: 6px 12px; border: none; cursor: pointer;
      background: #e0e0e0; margin-right: 5px;
    }
    #controls { margin-bottom: 10px; }
    select { padding: 4px; }
  </style>
</head>
<body>
  <h2>Inventory / Purchase Order Dashboard</h2>

  <div id="controls">
    <button id="modeToggle" class="mode-btn">Switch to Purchase Order</button>
    <button id="altToggle" style="display:none;">Use Alt Supplier</button>

    <select id="supplierFilter" multiple size="4"></select>
  </div>

  <div id="tableContainer"></div>

  <button id="downloadBtn" style="display:none;">Download CSV</button>
  <button id="submitBtn" style="display:none;">Submit Order</button>

  <script>
    const apiUrl = 'https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec';
    let isPO = false;
    let useAlt = false;
    let allItems = [];
    let orderData = {};
    let selectedSuppliers = [];

    document.getElementById('modeToggle').onclick = toggleMode;
    document.getElementById('altToggle').onclick = toggleAltSupplier;
    document.getElementById('submitBtn').onclick = submitOrders;
    document.getElementById('downloadBtn').onclick = downloadCSV;

    function toggleMode() {
      isPO = !isPO;
      orderData = {};
      document.getElementById('modeToggle').textContent = isPO ? 'Switch to Inventory' : 'Switch to Purchase Order';
      document.getElementById('modeToggle').classList.toggle('active', isPO);
      document.getElementById('altToggle').style.display = isPO ? 'inline-block' : 'none';
      document.getElementById('submitBtn').style.display = isPO ? 'inline-block' : 'none';
      document.getElementById('downloadBtn').style.display = isPO ? 'inline-block' : 'none';
      fetchData();
    }

    function toggleAltSupplier() {
      useAlt = !useAlt;
      document.getElementById('altToggle').classList.toggle('active', useAlt);
      renderTable();
    }

    async function fetchData() {
      const suppliersParam = selectedSuppliers.map(s => encodeURIComponent(s)).join(',');
      const mode = isPO ? 'po' : 'inventory';
      const res = await fetch(`${apiUrl}?mode=${mode}&suppliers=${suppliersParam}`);
      const data = await res.json();
      allItems = data.items || [];
      populateSupplierFilter(data.suppliers || []);
      renderTable();
    }

    function populateSupplierFilter(suppliers) {
      const filter = document.getElementById('supplierFilter');
      filter.innerHTML = '';
      suppliers.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        opt.selected = true;
        filter.appendChild(opt);
      });
      selectedSuppliers = suppliers;
      filter.onchange = () => {
        selectedSuppliers = Array.from(filter.selectedOptions).map(opt => opt.value);
        fetchData();
      };
    }

    function renderTable() {
      const container = document.getElementById('tableContainer');
      if (allItems.length === 0) {
        container.innerHTML = '<p>No data found.</p>';
        return;
      }

      let html = `<table><thead><tr>
        <th>Barcode</th><th>Item Name</th><th>Supplier</th><th>Purchase Price</th>`;

      if (isPO) html += `<th>Order Qty</th><th>Order Amount</th>`;
      else html += `<th>Inventory</th><th>Value</th>`;
      html += `</tr></thead><tbody>`;

      allItems.forEach(item => {
        const supplier = useAlt ? item.supplier2 : item.supplier1;
        const price = useAlt ? item.altPurchasePrice : item.purchasePrice;

        let row = `<tr${isPO && orderData[item.barcode] ? ' class="highlight"' : ''}>`;
        row += `<td>${item.barcode}</td>`;
        row += `<td>${item.name}</td>`;
        row += `<td>${supplier}</td>`;
        row += `<td>${price.toFixed(2)}</td>`;

        if (isPO) {
          const qty = orderData[item.barcode]?.qty || '';
          const amt = orderData[item.barcode]?.amount || 0;
          row += `<td><input type="number" min="0" value="${qty}" oninput="updateQty('${item.barcode}', this.value, ${price})"></td>`;
          row += `<td>${amt ? amt.toFixed(2) : ''}</td>`;
        } else {
          const inv = item.currentInventory || 0;
          row += `<td>${inv}</td>`;
          row += `<td>${(inv * price).toFixed(2)}</td>`;
        }

        row += `</tr>`;
        html += row;
      });

      html += `</tbody></table>`;
      container.innerHTML = html;
    }

    function updateQty(barcode, qty, price) {
      qty = parseInt(qty) || 0;
      if (qty > 0) {
        orderData[barcode] = {
          qty,
          amount: qty * price,
          barcode,
          name: allItems.find(i => i.barcode === barcode)?.name || '',
          supplier: useAlt
            ? allItems.find(i => i.barcode === barcode)?.supplier2 || ''
            : allItems.find(i => i.barcode === barcode)?.supplier1 || ''
        };
      } else {
        delete orderData[barcode];
      }
      renderTable();
    }

    async function submitOrders() {
      const payload = Object.values(orderData);
      if (!payload.length) return alert('No orders to submit.');
      const res = await fetch(`${apiUrl}?action=save`, {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: { 'Content-Type': 'application/json' }
      });
      const result = await res.text();
      alert('Orders saved successfully.');
      orderData = {};
      fetchData();
    }

    function downloadCSV() {
      let csv = 'Barcode,Item Name,Supplier,Quantity,Amount\n';
      Object.values(orderData).forEach(order => {
        csv += `"${order.barcode}","${order.name}","${order.supplier}",${order.qty},${order.amount}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'purchase_orders.csv';
      link.click();
    }

    window.onload = fetchData;
  </script>
</body>
</html>
