<!DOCTYPE html>
<html>
<head>
  <title>Inventory & Purchase Orders</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .controls {
      display: flex;
      gap: 10px;
    }
    .search-bar {
      margin-left: auto;
    }
    #supplier-filter {
      display: none;
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      z-index: 1000;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
    }
    .zero-inventory {
      background-color: #ffe5e5;
    }
    #total-order {
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="controls">
      <button onclick="toggleSupplierFilter()">Filter Suppliers</button>
      <button onclick="toggleAltSupplier()">Use Alt Supplier</button>
      <button onclick="submitOrders()">Submit Orders</button>
      <button onclick="downloadCSV()">Download CSV</button>
    </div>
    <input class="search-bar" type="text" id="search" placeholder="Search item or barcode" oninput="renderTable()">
  </div>

  <div id="supplier-filter"></div>

  <table id="data-table"></table>

  <div id="total-order"></div>

  <script>
    const apiUrl = 'https://script.google.com/macros/s/AKfycbzW4L7UzSpfI4ToovkZ3v8RmS8XQbnMjCBeVX4J_JEdWxVlKuhQ_pbfU3lvoog7sy2T/exec';

    let allData = [];
    let filteredSuppliers = [];
    let useAlt = false;

    async function fetchData() {
      const res = await fetch(apiUrl);
      const json = await res.json();
      allData = json.items;
      renderSupplierFilter(json.suppliers);
      filteredSuppliers = [...json.suppliers];
      renderTable();
    }

    function renderSupplierFilter(suppliers) {
      const container = document.getElementById('supplier-filter');
      container.innerHTML = '';
      const checkboxAll = document.createElement('input');
      checkboxAll.type = 'checkbox';
      checkboxAll.checked = true;
      checkboxAll.id = 'selectAll';
      const labelAll = document.createElement('label');
      labelAll.textContent = 'Select All';
      labelAll.prepend(checkboxAll);
      container.appendChild(labelAll);
      container.appendChild(document.createElement('br'));

      checkboxAll.addEventListener('change', () => {
        document.querySelectorAll('#supplier-filter input[type=checkbox]').forEach(cb => {
          cb.checked = checkboxAll.checked;
        });
        filteredSuppliers = checkboxAll.checked ? suppliers : [];
        renderTable();
      });

      suppliers.forEach(supplier => {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        checkbox.dataset.supplier = supplier;
        const label = document.createElement('label');
        label.textContent = supplier;
        label.prepend(checkbox);
        container.appendChild(label);
        container.appendChild(document.createElement('br'));

        checkbox.addEventListener('change', () => {
          const selected = Array.from(document.querySelectorAll('#supplier-filter input[data-supplier]:checked'))
            .map(cb => cb.dataset.supplier);
          filteredSuppliers = selected;
          renderTable();
          container.style.display = 'none';
        });
      });
    }

    function toggleSupplierFilter() {
      const filterBox = document.getElementById('supplier-filter');
      filterBox.style.display = filterBox.style.display === 'none' ? 'block' : 'none';
    }

    function toggleAltSupplier() {
      useAlt = !useAlt;
      renderTable();
    }

    function renderTable() {
      const table = document.getElementById('data-table');
      const search = document.getElementById('search').value.toLowerCase();
      let totalOrder = 0;
      let html = `
        <tr>
          <th>Date</th>
          <th>Barcode</th>
          <th>Item Name</th>
          <th></th>
          <th>Supplier</th>
          <th>Purchase Price (PHP)</th>
          <th>Order Quantity</th>
          <th>Order Amount (PHP)</th>
        </tr>
      `;

      const now = new Date();
      const dateStr = `${now.getMonth()+1}/${now.getDate()}/${now.getFullYear()} ${now.toLocaleTimeString()}`;

      allData.filter(item => {
        const supplier = useAlt ? item.supplier2 : item.supplier1;
        return filteredSuppliers.includes(item.supplier1) &&
               (item.name.toLowerCase().includes(search) || item.barcode.includes(search)) &&
               !(item.totalSold === 0 && item.totalPurchased === 0);
      }).forEach(item => {
        const supplier = useAlt ? item.supplier2 : item.supplier1;
        const price = useAlt ? item.altPurchasePrice : item.purchasePrice;
        const rowClass = item.currentInventory === 0 ? 'zero-inventory' : '';
        html += `
          <tr class="${rowClass}">
            <td>${dateStr}</td>
            <td>${item.barcode}</td>
            <td>${item.name}</td>
            <td></td>
            <td>${supplier}</td>
            <td>${price}</td>
            <td><input type="number" min="0" value="0" onchange="updateAmount(this)"></td>
            <td class="amount">0</td>
          </tr>
        `;
      });

      table.innerHTML = html;
      updateTotal();
    }

    function updateAmount(input) {
      const row = input.closest('tr');
      const price = parseFloat(row.children[5].textContent);
      const qty = parseInt(input.value) || 0;
      const amount = qty * price;
      row.querySelector('.amount').textContent = amount.toFixed(2);
      updateTotal();
    }

    function updateTotal() {
      let total = 0;
      document.querySelectorAll('.amount').forEach(cell => {
        total += parseFloat(cell.textContent) || 0;
      });
      document.getElementById('total-order').textContent = `Total Order Amount: PHP ${total.toFixed(2)}`;
    }

    function submitOrders() {
      const rows = document.querySelectorAll('#data-table tr');
      const orders = [];
      rows.forEach((row, idx) => {
        if (idx === 0) return;
        const qty = parseInt(row.children[6].querySelector('input')?.value || 0);
        if (qty > 0) {
          orders.push({
            barcode: row.children[1].textContent,
            name: row.children[2].textContent,
            supplier: row.children[4].textContent,
            qty,
            amount: parseFloat(row.children[7].textContent)
          });
        }
      });

      google.script.run.savePurchaseOrders(orders);
      alert('Orders submitted!');
    }

    function downloadCSV() {
      const rows = document.querySelectorAll('#data-table tr');
      const now = new Date();
      const dateStr = `${now.getMonth()+1}-${now.getDate()}-${now.getFullYear()}_${now.getHours()}-${now.getMinutes()}`;
      const supplierLabel = useAlt ? '_Alt' : '';
      const fileName = `PO_${dateStr}${supplierLabel}.csv`;
      const csv = ['Date,Barcode,Item Name,,Supplier,PURCHASE PRICE,Order Quantity,Total order amount'];

      rows.forEach((row, idx) => {
        if (idx === 0) return;
        const qty = parseInt(row.children[6].querySelector('input')?.value || 0);
        if (qty > 0) {
          const rowData = [
            row.children[0].textContent,
            `"${row.children[1].textContent}"`,
            row.children[2].textContent,
            '',
            row.children[4].textContent,
            row.children[5].textContent,
            qty,
            row.children[7].textContent
          ];
          csv.push(rowData.join(','));
        }
      });

      const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    fetchData();
  </script>
</body>
</html>
