<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventory & Purchase Order</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 10px;
    }
    .left-controls, .right-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    .highlight-zero {
      background-color: #ffe5e5;
    }
    .highlight-order {
      background-color: #e0ffe0;
    }
    .dropdown {
      position: relative;
    }
    .dropdown-content {
      position: absolute;
      background-color: white;
      border: 1px solid #ccc;
      z-index: 10;
      padding: 10px;
      display: none;
      max-height: 200px;
      overflow-y: auto;
    }
    .dropdown-content label {
      display: block;
    }
    .show { display: block; }
  </style>
</head>
<body>
  <div class="controls">
    <div class="left-controls">
      <button onclick="toggleMode()" id="modeToggle">Purchase Order</button>
      <button onclick="toggleAltSupplier()">Use Alt Supplier</button>
      <div class="dropdown" id="supplierDropdown">
        <button onclick="toggleSupplierDropdown()">Select Suppliers</button>
        <div class="dropdown-content" id="supplierList"></div>
      </div>
      <button onclick="submitOrders()">Submit Orders</button>
      <button onclick="downloadCSV()">Download CSV</button>
    </div>
    <div class="right-controls">
      <input type="text" id="searchBar" placeholder="Search by name or barcode" onkeyup="renderTable()">
    </div>
  </div>

  <div id="totalAmountCell">Total Order Amount: PHP 0.00</div>

  <table>
    <thead>
      <tr>
        <th>Barcode</th>
        <th>Item Name</th>
        <th>Current Inventory</th>
        <th>Supplier</th>
        <th>Purchase Price</th>
        <th>Order Quantity</th>
        <th>Order Amount</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    const apiUrl = 'https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec'; // Replace with actual Google Apps Script deployed URL
    let allItems = [];
    let selectedSuppliers = [];
    let useAlt = false;
    let isPO = false;
    let allSuppliers = [];
    let orderData = {}; // barcode: { qty, amount }

    window.onload = async () => {
      const res = await fetch(`${apiUrl}?mode=suppliersOnly`);
      const data = await res.json();
      allSuppliers = data.suppliers;
      selectedSuppliers = [...allSuppliers];
      renderSupplierDropdown();
      fetchData(true); // Load inventory view by default
    };

    async function fetchData(isInventoryMode) {
      const suppliersQuery = encodeURIComponent(JSON.stringify(selectedSuppliers));
      const url = `${apiUrl}?mode=${isInventoryMode ? 'inventory' : 'po'}&suppliers=${suppliersQuery}`;
      const res = await fetch(url);
      const data = await res.json();
      const newItems = data.items;

      if (isInventoryMode) {
        allItems = newItems;
      } else {
        const existingBarcodes = new Set(allItems.map(i => i.barcode));
        const merged = [...allItems];
        for (const item of newItems) {
          if (!existingBarcodes.has(item.barcode)) merged.push(item);
        }
        allItems = merged;
      }

      renderTable();
    }

    function renderSupplierDropdown() {
      const container = document.getElementById('supplierList');
      container.innerHTML = '';

      const allBox = document.createElement('input');
      allBox.type = 'checkbox';
      allBox.id = 'selectAllSuppliers';
      allBox.checked = selectedSuppliers.length === allSuppliers.length;
      allBox.onchange = () => {
        selectedSuppliers = allBox.checked ? [...allSuppliers] : [];
        fetchData(!isPO);
        container.classList.remove('show');
      };
      container.appendChild(allBox);
      container.appendChild(document.createTextNode(' Select All'));

      allSuppliers.forEach(supplier => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = supplier;
        checkbox.checked = selectedSuppliers.includes(supplier);
        checkbox.onchange = () => {
          if (checkbox.checked) {
            if (!selectedSuppliers.includes(supplier)) selectedSuppliers.push(supplier);
          } else {
            selectedSuppliers = selectedSuppliers.filter(s => s !== supplier);
          }
          document.getElementById('selectAllSuppliers').checked = selectedSuppliers.length === allSuppliers.length;
          fetchData(!isPO);
          container.classList.remove('show');
        };
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(' ' + supplier));
        container.appendChild(label);
      });
    }

    function toggleSupplierDropdown() {
      document.getElementById('supplierList').classList.toggle('show');
    }

    function toggleAltSupplier() {
      useAlt = !useAlt;
      renderTable();
    }

    function toggleMode() {
      isPO = !isPO;
      orderData = {};
      allItems = [];
      document.getElementById('modeToggle').textContent = isPO ? 'Inventory' : 'Purchase Order';
      if (!isPO) {
        selectedSuppliers = [...allSuppliers];
      } else {
        selectedSuppliers = [];
      }
      fetchData(!isPO);
    }

    function renderTable() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      const search = document.getElementById('searchBar').value.toLowerCase();

      const visibleItems = allItems
        .filter(item =>
          (selectedSuppliers.length === 0 || selectedSuppliers.includes(item.supplier1)) &&
          (item.name.toLowerCase().includes(search) || item.barcode.toLowerCase().includes(search))
        )
        .sort((a, b) => {
          const sA = (a.supplier1 || '').toLowerCase();
          const sB = (b.supplier1 || '').toLowerCase();
          return sA === sB ? a.name.localeCompare(b.name) : sA.localeCompare(sB);
        });

      visibleItems.forEach(item => {
        const supplier = useAlt ? item.supplier2 || item.supplier1 : item.supplier1;
        const price = useAlt ? item.altPurchasePrice || item.purchasePrice : item.purchasePrice;
        const barcode = item.barcode;
        const savedQty = orderData[barcode]?.qty || 0;
        const amount = price * savedQty;

        const tr = document.createElement('tr');
        if (item.currentInventory === 0) tr.classList.add('highlight-zero');
        if (savedQty > 0) tr.classList.add('highlight-order');

        tr.innerHTML = `
          <td>${barcode}</td>
          <td>${item.name}</td>
          <td>${item.currentInventory}</td>
          <td>${supplier}</td>
          <td>${price.toFixed(2)}</td>
          <td><input type="number" min="0" value="${savedQty}" onchange="updateQty(this, '${barcode}', ${price})"></td>
          <td>${amount.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });

      updateTotalAmount();
    }

    function updateQty(input, barcode, price) {
      const qty = parseInt(input.value) || 0;
      orderData[barcode] = { qty, amount: qty * price };
      renderTable(); // Re-render to update highlights and totals
    }

    function updateTotalAmount() {
      let total = 0;
      Object.values(orderData).forEach(o => total += o.amount);
      document.getElementById('totalAmountCell').textContent = `Total Order Amount: PHP ${total.toFixed(2)}`;
    }

    function submitOrders() {
      const orders = Object.entries(orderData)
        .filter(([_, data]) => data.qty > 0)
        .map(([barcode, data]) => {
          const item = allItems.find(i => i.barcode === barcode);
          return {
            barcode,
            name: item.name,
            supplier: useAlt ? item.supplier2 || item.supplier1 : item.supplier1,
            qty: data.qty,
            amount: data.amount
          };
        });
      if (!orders.length) return alert('No orders to submit.');
      google.script.run.savePurchaseOrders(orders);
      alert('Orders submitted successfully!');
    }

    function downloadCSV() {
      const rows = [['Date', 'Barcode', 'Item Name', '', 'Supplier', 'Purchase Price', 'Order Quantity', 'Total Order Amount']];
      const now = new Date();
      const timestamp = `${now.getMonth()+1}/${now.getDate()}/${now.getFullYear()} ${now.toLocaleTimeString('en-US',{hour12:false})}`;
      const filename = `PO_${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}_${now.getHours()}-${now.getMinutes()}.csv`;

      Object.entries(orderData).forEach(([barcode, data]) => {
        if (data.qty > 0) {
          const item = allItems.find(i => i.barcode === barcode);
          const supplier = useAlt ? item.supplier2 || item.supplier1 : item.supplier1;
          const price = useAlt ? item.altPurchasePrice || item.purchasePrice : item.purchasePrice;
          rows.push([
            timestamp,
            `="${barcode}"`,
            item.name,
            '',
            supplier,
            price.toFixed(2),
            data.qty,
            data.amount.toFixed(2)
          ]);
        }
      });

      const csvContent = rows.map(e => e.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.setAttribute('href', URL.createObjectURL(blob));
      link.setAttribute('download', filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
