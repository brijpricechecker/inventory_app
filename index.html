<!DOCTYPE html>
<html>
<head>
  <title>Inventory & Purchase Order</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content {
      display: none; position: absolute; background-color: #f9f9f9;
      border: 1px solid #ccc; padding: 10px; z-index: 1;
      max-height: 200px; overflow-y: auto; min-width: 200px;
    }
    .dropdown-content label { display: block; margin-bottom: 5px; }
    .dropdown:hover .dropdown-content { display: block; }
    .hidden { display: none; }
    .view-toggle { margin-bottom: 15px; }
  </style>
</head>
<body>
  <h2>Inventory & Purchase Order</h2>

  <div class="view-toggle">
    <label><input type="radio" name="view" value="inventory" checked> Inventory</label>
    <label><input type="radio" name="view" value="purchase"> Purchase Order</label>
  </div>

  <div class="dropdown">
    <button>Select Supplier</button>
    <div class="dropdown-content" id="supplierDropdown"></div>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th class="po-only hidden">Select</th>
        <th>Barcode</th>
        <th>Item Name</th>
        <th>Supplier</th>
        <th>Current Inventory</th>
        <th class="po-only hidden">Purchase Price</th>
        <th class="po-only hidden">Order Qty</th>
        <th class="po-only hidden">Order Amount</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec";
    let supplierFilter = new Set();
    let fullData = [];

    document.querySelectorAll('input[name="view"]').forEach(radio => {
      radio.addEventListener('change', toggleView);
    });

    function toggleView() {
      const view = document.querySelector('input[name="view"]:checked').value;
      const poColumns = document.querySelectorAll('.po-only');
      poColumns.forEach(col => col.classList.toggle('hidden', view !== 'purchase'));
      renderTable();
    }

    function fetchData() {
      fetch(API_URL)
        .then(res => res.json())
        .then(data => {
          fullData = data;
          renderSupplierFilter();
          supplierFilter = new Set(data.map(row => row.supplier)); // select all by default
          renderTable();
        });
    }

    function renderSupplierFilter() {
      const dropdown = document.getElementById("supplierDropdown");
      const suppliers = [...new Set(fullData.map(d => d.supplier))];
      dropdown.innerHTML = `<label><input type="checkbox" id="selectAll" checked> Select All</label>`;

      suppliers.forEach(supplier => {
        dropdown.innerHTML += `<label><input type="checkbox" class="supplier-checkbox" value="${supplier}" checked> ${supplier}</label>`;
      });

      dropdown.querySelector('#selectAll').addEventListener('change', function() {
        const checkboxes = dropdown.querySelectorAll('.supplier-checkbox');
        checkboxes.forEach(cb => {
          cb.checked = this.checked;
          if (this.checked) supplierFilter.add(cb.value);
          else supplierFilter.delete(cb.value);
        });
        renderTable();
      });

      dropdown.querySelectorAll('.supplier-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
          if (this.checked) supplierFilter.add(this.value);
          else supplierFilter.delete(this.value);

          const allChecked = [...dropdown.querySelectorAll('.supplier-checkbox')].every(cb => cb.checked);
          dropdown.querySelector('#selectAll').checked = allChecked;

          renderTable();
        });
      });
    }

    function renderTable() {
      const view = document.querySelector('input[name="view"]:checked').value;
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";

      fullData.filter(row => supplierFilter.has(row.supplier)).forEach(row => {
        const tr = document.createElement("tr");

        const altSupplier = row.altSupplier;
        const useAlt = false;
        const selectedSupplier = useAlt ? altSupplier : row.supplier;
        const purchasePrice = useAlt ? Number(row.altPurchasePrice) : Number(row.purchasePrice);

        if (view === 'purchase') {
          tr.innerHTML += `<td><input type="checkbox" class="select-item" data-barcode="${row.barcode}" checked></td>`;
        }

        tr.innerHTML += `
          <td>${row.barcode}</td>
          <td>${row.name}</td>
          <td>
            <select class="supplier-select">
              <option value="main">${row.supplier}</option>
              <option value="alt">${row.altSupplier || ""}</option>
            </select>
          </td>
          <td>${row.currentInventory}</td>
        `;

        if (view === 'purchase') {
          tr.innerHTML += `
            <td class="price">${purchasePrice}</td>
            <td><input type="number" class="order-qty" value="1" min="1"></td>
            <td class="order-amount">${purchasePrice * 1}</td>
          `;
        }

        tbody.appendChild(tr);
      });

      attachEvents();
    }

    function attachEvents() {
      document.querySelectorAll('.supplier-select').forEach(select => {
        select.addEventListener('change', function () {
          const row = this.closest('tr');
          const barcode = row.cells[1].textContent;
          const data = fullData.find(d => d.barcode === barcode);
          const price = this.value === 'alt' ? Number(data.altPurchasePrice) : Number(data.purchasePrice);

          row.querySelector('.price').textContent = price;
          const qty = Number(row.querySelector('.order-qty').value);
          row.querySelector('.order-amount').textContent = price * qty;
        });
      });

      document.querySelectorAll('.order-qty').forEach(input => {
        input.addEventListener('input', function () {
          const row = this.closest('tr');
          const price = Number(row.querySelector('.price').textContent);
          row.querySelector('.order-amount').textContent = price * Number(this.value);
        });
      });
    }

    fetchData();
  </script>
</body>
</html>
