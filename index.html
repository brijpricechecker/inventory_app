<!DOCTYPE html>
<html>
<head>
  <title>Inventory and Purchase Order</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table, th, td { border: 1px solid #ddd; border-collapse: collapse; padding: 8px; }
    table { width: 100%; margin-top: 10px; }
    th { background-color: #f2f2f2; }
    .controls { display: flex; gap: 10px; margin-bottom: 10px; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content {
      display: none; position: absolute; background-color: white; border: 1px solid #ccc;
      max-height: 200px; overflow-y: auto; z-index: 1; padding: 10px;
    }
    .dropdown-content label { display: block; }
    .dropdown.show .dropdown-content { display: block; }
    button { padding: 8px 12px; cursor: pointer; }
  </style>
</head>
<body>

  <div class="controls">
    <div class="dropdown" id="supplierDropdown">
      <button onclick="toggleDropdown()">Filter Suppliers</button>
      <div class="dropdown-content" id="supplierList"></div>
    </div>
    <button onclick="toggleAltSupplier()">Use Alt Supplier</button>
    <button onclick="submitOrders()">Submit Orders</button>
    <button onclick="downloadCSV()">Download CSV</button>
  </div>

  <table id="inventoryTable">
    <thead>
      <tr>
        <th>Barcode</th>
        <th>Item Name</th>
        <th>Supplier</th>
        <th>Purchase Price</th>
        <th>Total Sold</th>
        <th>Current Inventory</th>
        <th>Order Quantity</th>
        <th>Order Amount</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  let allData = [];
  let useAltSupplier = false;

  async function fetchData() {
    const res = await fetch('https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec'); // Replace with your deployed Apps Script URL
    const data = await res.json();
    allData = data.items;
    populateSupplierFilter(data.suppliers);
    renderTable();
  }

  function populateSupplierFilter(suppliers) {
    const list = document.getElementById('supplierList');
    list.innerHTML = '';
    suppliers.forEach(sup => {
      const id = `sup_${sup.replace(/\s+/g, '_')}`;
      list.innerHTML += `
        <label><input type="checkbox" value="${sup}" id="${id}" checked> ${sup}</label>
      `;
    });
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('supplierDropdown');
      if (!dropdown.contains(e.target)) dropdown.classList.remove('show');
    });
  }

  function toggleDropdown() {
    document.getElementById('supplierDropdown').classList.toggle('show');
    renderTable();
  }

  function getSelectedSuppliers() {
    const checkboxes = document.querySelectorAll('#supplierList input[type="checkbox"]');
    return Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
  }

  function toggleAltSupplier() {
    useAltSupplier = !useAltSupplier;
    renderTable();
  }

  function renderTable() {
    const selectedSuppliers = getSelectedSuppliers();
    const tbody = document.querySelector('#inventoryTable tbody');
    tbody.innerHTML = '';

    allData.forEach(item => {
      const supplier = useAltSupplier ? item.supplier2 : item.supplier1;
      const price = useAltSupplier ? (item.altPurchasePrice || 0) : item.purchasePrice;

      if (!selectedSuppliers.includes(supplier)) return;

      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td>${item.barcode}</td>
        <td>${item.name}</td>
        <td>${supplier}</td>
        <td>${price.toFixed(2)}</td>
        <td>${item.totalSold}</td>
        <td>${item.currentInventory}</td>
        <td><input type="number" min="0" value="0" style="width:60px" onchange="updateAmount(this)"></td>
        <td class="amount">0.00</td>
      `;

      tr.dataset.barcode = item.barcode;
      tr.dataset.name = item.name;
      tr.dataset.supplier = supplier;
      tr.dataset.price = price;

      tbody.appendChild(tr);
    });
  }

  function updateAmount(input) {
    const row = input.closest('tr');
    const qty = parseFloat(input.value) || 0;
    const price = parseFloat(row.dataset.price);
    row.querySelector('.amount').textContent = (qty * price).toFixed(2);
  }

  async function submitOrders() {
    const orders = [];
    const rows = document.querySelectorAll('#inventoryTable tbody tr');

    rows.forEach(row => {
      const qty = parseFloat(row.querySelector('input').value) || 0;
      if (qty <= 0) return;

      orders.push({
        barcode: row.dataset.barcode,
        name: row.dataset.name,
        supplier: row.dataset.supplier,
        qty,
        amount: (qty * parseFloat(row.dataset.price)).toFixed(2)
      });
    });

    if (orders.length === 0) {
      alert("No orders to submit.");
      return;
    }

    await fetch('https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec', {
      method: 'POST',
      body: JSON.stringify({ orders }),
      headers: { 'Content-Type': 'application/json' }
    });

    alert("Orders submitted!");
  }

  function downloadCSV() {
    const rows = document.querySelectorAll('#inventoryTable tbody tr');
    const csvRows = [["Barcode", "Item Name", "Supplier", "Qty", "Amount"]];
    let supplierUsed = new Set();

    rows.forEach(row => {
      const qty = parseFloat(row.querySelector('input').value) || 0;
      if (qty <= 0) return;

      const barcode = row.dataset.barcode;
      const name = row.dataset.name;
      const supplier = row.dataset.supplier;
      const amount = (qty * parseFloat(row.dataset.price)).toFixed(2);
      supplierUsed.add(supplier);

      csvRows.push([barcode, name, supplier, qty, amount]);
    });

    if (csvRows.length === 1) {
      alert("No orders to download.");
      return;
    }

    const now = new Date();
    const timestamp = now.toISOString().replace(/[:\-T]/g, "").slice(0, 14);
    const supplierTag = supplierUsed.size === 1 ? Array.from(supplierUsed)[0].replace(/\s+/g, "_") : "MULTI";
    const filename = `PO_${timestamp}_${supplierTag}.csv`;

    const csvContent = csvRows.map(e => e.join(",")).join("\n");
    const blob = new Blob([csvContent], { type: "text/csv" });
    const link = document.createElement("a");

    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  }

  fetchData();
</script>

</body>
</html>
