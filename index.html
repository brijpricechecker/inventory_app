<!DOCTYPE html>
<html>
<head>
  <title>Inventory Management</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
    }
    .filter-group {
      margin-bottom: 16px;
    }
    .popup {
      position: relative;
      display: inline-block;
    }
    .popup-content {
      display: none;
      position: absolute;
      background-color: #fff;
      min-width: 200px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      z-index: 1;
      padding: 8px;
    }
    .popup:hover .popup-content {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .button {
      margin-top: 12px;
      padding: 8px 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <h2>Inventory Management</h2>

  <div class="filter-group">
    <label>Filter by Supplier:</label>
    <div class="popup">
      <button class="button">Select Suppliers</button>
      <div class="popup-content" id="supplierCheckboxes"></div>
    </div>
  </div>

  <table id="inventoryTable">
    <thead>
      <tr>
        <th>Barcode</th>
        <th>Item Name</th>
        <th>Supplier</th>
        <th>Total Sold</th>
        <th>Current Inventory</th>
        <th>Order Quantity</th>
        <th>Order Amount</th>
        <th>Select</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button class="button" onclick="submitOrders()">Submit Orders</button>
  <button class="button" onclick="downloadCSV()">Download CSV</button>
  <p><strong>Web App URL:</strong>https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec</p>

  <script>
    let allInventory = [];
    let selectedSuppliers = new Set();

    function fetchInventory() {
      fetch('https://script.google.com/macros/s/YOUR_DEPLOYED_WEB_APP_ID/exec')
        .then(res => res.json())
        .then(data => {
          allInventory = data;
          populateSupplierFilter(data);
          selectedSuppliers = new Set([...new Set(data.map(i => i.supplier))]);
          renderTable();
        });
    }

    function populateSupplierFilter(data) {
      const uniqueSuppliers = [...new Set(data.map(row => row.supplier))];
      const container = document.getElementById('supplierCheckboxes');
      container.innerHTML = '';

      uniqueSuppliers.forEach(supplier => {
        const label = document.createElement('label');
        label.style.display = 'block';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = supplier;
        checkbox.checked = true;
        checkbox.onchange = () => {
          if (checkbox.checked) {
            selectedSuppliers.add(checkbox.value);
          } else {
            selectedSuppliers.delete(checkbox.value);
          }
          renderTable();
        };
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(' ' + supplier));
        container.appendChild(label);
      });
    }

    function renderTable() {
      const tbody = document.querySelector("#inventoryTable tbody");
      tbody.innerHTML = '';

      const filteredData = allInventory.filter(row => selectedSuppliers.has(row.supplier));

      filteredData.forEach(row => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${row.barcode}</td>
          <td>${row.name}</td>
          <td>${row.supplier}</td>
          <td>${row.totalSold}</td>
          <td>${row.currentInventory}</td>
          <td><input type="number" min="0" value="0" onchange="updateAmount(this)"></td>
          <td class="amount">0</td>
          <td><input type="checkbox" class="order-select"></td>
        `;

        tbody.appendChild(tr);
      });
    }

    function updateAmount(input) {
      const quantity = Number(input.value);
      const row = input.closest('tr');
      const barcode = row.children[0].textContent;
      const item = allInventory.find(i => i.barcode === barcode);
      const amountCell = row.querySelector(".amount");
      const price = item?.purchasePrice || 0;
      amountCell.textContent = (quantity * price).toFixed(2);
    }

    function submitOrders() {
      const selectedOrders = [];
      const rows = document.querySelectorAll("#inventoryTable tbody tr");

      rows.forEach(row => {
        if (row.querySelector(".order-select").checked) {
          const barcode = row.children[0].textContent;
          const name = row.children[1].textContent;
          const supplier = row.children[2].textContent;
          const qty = Number(row.querySelector("input[type=number]").value);
          const amount = row.querySelector(".amount").textContent;
          selectedOrders.push({ barcode, name, supplier, qty, amount });
        }
      });

      if (selectedOrders.length === 0) {
        alert("No orders selected.");
        return;
      }

      google.script.run.withSuccessHandler(() => {
        alert("Orders submitted!");
      }).savePurchaseOrders(selectedOrders);
    }

    function downloadCSV() {
      const selectedOrders = [];
      const rows = document.querySelectorAll("#inventoryTable tbody tr");

      rows.forEach(row => {
        if (row.querySelector(".order-select").checked) {
          const barcode = row.children[0].textContent;
          const name = row.children[1].textContent;
          const supplier = row.children[2].textContent;
          const qty = Number(row.querySelector("input[type=number]").value);
          const amount = row.querySelector(".amount").textContent;
          selectedOrders.push([barcode, name, supplier, qty, amount]);
        }
      });

      if (selectedOrders.length === 0) {
        alert("No orders to download.");
        return;
      }

      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Barcode,Item Name,Supplier,Qty,Amount\n";
      selectedOrders.forEach(row => {
        csvContent += row.join(",") + "\n";
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "purchase_orders.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    window.onload = fetchInventory;
  </script>
</body>
</html>
