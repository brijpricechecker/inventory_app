<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Inventory & Purchase Order Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    #supplierFilterPopup {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      display: none;
      z-index: 10;
    }
    #supplierFilterPopup label {
      display: block;
    }
    .highlight {
      background-color: #f9f871;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }
    th {
      background-color: #eee;
      cursor: pointer;
    }
    input[type="number"] {
      width: 60px;
    }
    #totalAmount {
      float: right;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="controls">
  <div>
    <button id="modeToggle" onclick="toggleMode()">Purchase Order</button>
    <button id="altToggle" onclick="toggleAltSupplier()" style="display:none;">Use Alt Supplier</button>
    <button onclick="toggleSupplierFilter()">Filter Suppliers</button>
  </div>
  <div>
    <button onclick="exportToCSV()">Export to CSV</button>
    <span id="totalAmount"></span>
  </div>
</div>

<div id="supplierFilterPopup"></div>
<div id="tableContainer"></div>

<script>
  const apiUrl = 'https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec'; // Replace with your actual URL
  let isPO = true;
  let useAlt = false;
  let allItems = [];
  let selectedSuppliers = [];
  let orderData = {};
  let allSuppliers = [];
  let currentSort = { column: '', asc: true };

  document.addEventListener("click", () => {
    document.getElementById("supplierFilterPopup").style.display = "none";
  });

  function toggleMode() {
    isPO = !isPO;
    orderData = {};
    useAlt = false;
    document.getElementById('modeToggle').textContent = isPO ? 'Inventory' : 'Purchase Order';
    document.getElementById('altToggle').style.display = isPO ? 'inline-block' : 'none';
    fetchData();
  }

  function toggleAltSupplier() {
    useAlt = !useAlt;
    renderTable();
  }

  function toggleSupplierFilter() {
    const popup = document.getElementById("supplierFilterPopup");
    popup.style.display = popup.style.display === "block" ? "none" : "block";
    popup.innerHTML = `<label><input type="checkbox" onchange="selectAllSuppliers(this)" ${selectedSuppliers.length === allSuppliers.length ? 'checked' : ''}> Select All</label>`;
    allSuppliers.forEach(supplier => {
      const checked = selectedSuppliers.includes(supplier) ? 'checked' : '';
      popup.innerHTML += `<label><input type="checkbox" value="${supplier}" onchange="toggleSupplier(this)" ${checked}> ${supplier}</label>`;
    });
  }

  function selectAllSuppliers(box) {
    if (box.checked) {
      selectedSuppliers = [...allSuppliers];
    } else {
      selectedSuppliers = [];
    }
    fetchData();
  }

  function toggleSupplier(checkbox) {
    const val = checkbox.value;
    if (checkbox.checked) {
      selectedSuppliers.push(val);
    } else {
      selectedSuppliers = selectedSuppliers.filter(s => s !== val);
    }
    fetchData();
  }

  async function fetchData() {
    const suppliersParam = selectedSuppliers.map(s => encodeURIComponent(s)).join(',');
    const mode = isPO ? 'po' : 'inventory';
    const res = await fetch(`${apiUrl}?mode=${mode}&suppliers=${suppliersParam}`);
    const data = await res.json();
    allItems = data.items;
    allSuppliers = data.suppliers;
    if (selectedSuppliers.length === 0) selectedSuppliers = [...allSuppliers];
    renderTable();
  }

  function captureQty(barcode, value, price) {
    const qty = parseInt(value);
    if (!orderData[barcode]) {
      orderData[barcode] = { qty: 0 };
    }
    if (!isNaN(qty)) {
      orderData[barcode].qty = qty;
      orderData[barcode].amount = qty * price;
    } else {
      delete orderData[barcode];
    }
    renderTable();
  }

  function updateTotal() {
    if (!isPO) {
      document.getElementById("totalAmount").textContent = '';
      return;
    }
    let total = 0;
    Object.values(orderData).forEach(o => {
      total += o.amount || 0;
    });
    document.getElementById("totalAmount").textContent = `Total: â‚±${total.toFixed(2)}`;
  }

  function renderTable() {
    const container = document.getElementById('tableContainer');
    if (allItems.length === 0) {
      container.innerHTML = '<p>No data found.</p>';
      return;
    }

    const sortedItems = [...allItems];
    if (currentSort.column === 'inventory') {
      sortedItems.sort((a, b) => {
        const aVal = a.currentInventory || 0;
        const bVal = b.currentInventory || 0;
        return currentSort.asc ? aVal - bVal : bVal - aVal;
      });
    }

    let html = `<table><thead><tr>
      <th>Barcode</th><th>Item Name</th><th>Supplier</th><th>Purchase Price</th>`;

    if (isPO) {
      html += `<th onclick="toggleSort('inventory')">Current Inventory &#x21C5;</th><th>Order Qty</th><th>Order Amount</th>`;
    } else {
      html += `<th onclick="toggleSort('inventory')">Inventory &#x21C5;</th><th>Value</th>`;
    }

    html += `</tr></thead><tbody>`;

    sortedItems.forEach(item => {
      const supplier = useAlt ? item.supplier2 : item.supplier1;
      const price = useAlt ? item.altPurchasePrice : item.purchasePrice;
      const inv = item.currentInventory || 0;
      const order = orderData[item.barcode] || {};
      const qty = order.qty || '';
      const amt = qty && price ? qty * price : '';

      let row = `<tr${isPO && qty ? ' class="highlight"' : ''}>`;
      row += `<td>'${item.barcode}</td><td>${item.name}</td><td>${supplier}</td><td>${price.toFixed(2)}</td>`;

      if (isPO) {
        row += `<td>${inv}</td>`;
        row += `<td><input type="number" value="${qty}" onfocus="this.select()" oninput="captureQty('${item.barcode}', this.value, ${price})" onkeydown="event.stopPropagation();"></td>`;
        row += `<td>${amt ? amt.toFixed(2) : ''}</td>`;
      } else {
        row += `<td>${inv}</td><td>${(inv * price).toFixed(2)}</td>`;
      }

      row += '</tr>';
      html += row;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
    updateTotal();
  }

  function toggleSort(column) {
    if (currentSort.column === column) {
      currentSort.asc = !currentSort.asc;
    } else {
      currentSort.column = column;
      currentSort.asc = true;
    }
    renderTable();
  }

  function exportToCSV() {
    const rows = [];
    const today = new Date();
    const dateStr = today.toISOString().slice(0, 10);
    const supplierStr = selectedSuppliers.join('-').replace(/\s+/g, '_') || 'All';
    const prefix = isPO ? 'PO' : 'inventory';
    const filename = `${prefix}_${dateStr}_${supplierStr}.csv`;

    if (isPO) {
      rows.push(["Timestamp", "Barcode", "Item Name", "", "Supplier", "Purchase Price", "Order Quantity", "Order Amount"]);
      Object.entries(orderData).forEach(([barcode, order]) => {
        const item = allItems.find(i => i.barcode === barcode);
        const supplier = useAlt ? item.supplier2 : item.supplier1;
        const price = useAlt ? item.altPurchasePrice : item.purchasePrice;
        const amount = order.qty * price;
        rows.push([
          new Date().toLocaleString(),
          `'${barcode}`,
          item.name,
          '',
          supplier,
          price.toFixed(2),
          order.qty,
          amount.toFixed(2)
        ]);
      });
    } else {
      rows.push(["Barcode", "Item Name", "Supplier", "Purchase Price", "Inventory", "Value"]);
      allItems.forEach(item => {
        const supplier = useAlt ? item.supplier2 : item.supplier1;
        const price = useAlt ? item.altPurchasePrice : item.purchasePrice;
        const inv = item.currentInventory || 0;
        rows.push([
          `'${item.barcode}`,
          item.name,
          supplier,
          price.toFixed(2),
          inv,
          (inv * price).toFixed(2)
        ]);
      });
    }

    const csv = rows.map(r => r.map(v => `"${v}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  fetchData(); // Initial load
</script>
</body>
</html>
