<!DOCTYPE html>
<html>
<head>
  <title>Inventory & Purchase Order System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    #supplierFilterContainer {
      position: relative;
    }
    #supplierDropdown {
      display: none;
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      z-index: 10;
      max-height: 200px;
      overflow-y: auto;
    }
    #supplierDropdown label {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    .highlight-zero {
      background-color: #ffe5e5;
    }
    .highlight-order {
      background-color: #e6ffe6;
    }
    #totalAmount {
      margin-top: 10px;
      font-weight: bold;
    }
    .mode-btn {
      padding: 6px 12px;
    }
  </style>
</head>
<body>
  <div class="controls">
    <div>
      <button class="mode-btn" onclick="setMode('inventory')">Inventory View</button>
      <button class="mode-btn" onclick="setMode('po')">Purchase Order</button>
      <button class="mode-btn" onclick="toggleAltSupplier()">Use Alt Supplier</button>
    </div>
    <div id="supplierFilterContainer">
      <button onclick="toggleSupplierDropdown()">Select Suppliers</button>
      <div id="supplierDropdown"></div>
    </div>
    <input type="text" id="searchInput" placeholder="Search by name or barcode" oninput="renderTable()" />
    <button onclick="downloadCSV()">Download CSV</button>
    <button onclick="submitOrders()">Submit Orders</button>
  </div>

  <div id="totalAmount">Total Order Amount: PHP 0.00</div>

  <table>
    <thead>
      <tr>
        <th>Barcode</th>
        <th>Item Name</th>
        <th>Current Inventory</th>
        <th>Supplier</th>
        <th>Purchase Price</th>
        <th>Order Quantity</th>
        <th>Order Amount</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    let allItems = [], supplierList = [], selectedSuppliers = [], useAlt = false;
    let mode = 'inventory'; // 'inventory' or 'po'
    let orderData = {};

    function setMode(newMode) {
      mode = newMode;
      if (mode === 'inventory') {
        fetchData(true);
      } else {
        renderSupplierDropdown(); // Wait for user to select suppliers
        document.getElementById('tableBody').innerHTML = '';
      }
    }

    function toggleAltSupplier() {
      useAlt = !useAlt;
      renderTable();
    }

    function toggleSupplierDropdown() {
      const dropdown = document.getElementById('supplierDropdown');
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }

    function renderSupplierDropdown() {
      const container = document.getElementById('supplierDropdown');
      container.innerHTML = '';
      const selectAll = document.createElement('label');
      const allBox = document.createElement('input');
      allBox.type = 'checkbox';
      allBox.checked = selectedSuppliers.length === supplierList.length;
      allBox.onclick = () => {
        selectedSuppliers = allBox.checked ? [...supplierList] : [];
        container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = allBox.checked);
        if (mode === 'po' && selectedSuppliers.length > 0) fetchData(false);
        renderTable();
        toggleSupplierDropdown();
      };
      selectAll.appendChild(allBox);
      selectAll.appendChild(document.createTextNode(' Select All'));
      container.appendChild(selectAll);

      supplierList.forEach(supplier => {
        const label = document.createElement('label');
        const box = document.createElement('input');
        box.type = 'checkbox';
        box.checked = selectedSuppliers.includes(supplier);
        box.onchange = () => {
          if (box.checked) {
            selectedSuppliers.push(supplier);
          } else {
            selectedSuppliers = selectedSuppliers.filter(s => s !== supplier);
          }
          if (mode === 'po' && selectedSuppliers.length > 0) fetchData(false);
          renderTable();
          toggleSupplierDropdown();
        };
        label.appendChild(box);
        label.appendChild(document.createTextNode(' ' + supplier));
        container.appendChild(label);
      });
    }

    async function fetchData(filterActiveOnly) {
      const res = await fetch('https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec');
      const data = await res.json();
      supplierList = data.suppliers;
      renderSupplierDropdown();

      allItems = data.items;
      if (filterActiveOnly) {
        allItems = allItems.filter(item => item.totalSold > 0 || item.totalPurchased > 0);
      }
      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById('tableBody');
      const query = document.getElementById('searchInput').value.toLowerCase();
      tbody.innerHTML = '';

      let total = 0;
      let filtered = allItems
        .filter(item => selectedSuppliers.includes(item.supplier1))
        .filter(item =>
          item.name.toLowerCase().includes(query) || item.barcode.toLowerCase().includes(query)
        )
        .sort((a, b) => {
          if (a.supplier1 !== b.supplier1) return a.supplier1.localeCompare(b.supplier1);
          return a.name.localeCompare(b.name);
        });

      filtered.forEach(item => {
        const key = item.barcode;
        const supplier = useAlt ? item.supplier2 || item.supplier1 : item.supplier1;
        const price = useAlt ? item.altPurchasePrice || item.purchasePrice : item.purchasePrice;
        const currentInv = item.currentInventory ?? 0;

        const savedQty = orderData[key]?.qty || 0;
        const savedAmt = savedQty * price;

        const tr = document.createElement('tr');
        if (currentInv === 0) tr.classList.add('highlight-zero');
        if (savedQty > 0) tr.classList.add('highlight-order');

        tr.innerHTML = `
          <td>${item.barcode}</td>
          <td>${item.name}</td>
          <td>${currentInv}</td>
          <td>${supplier}</td>
          <td>${price.toFixed(2)}</td>
          <td><input type="number" min="0" value="${savedQty}" onchange="updateOrder(this, '${key}', ${price})"></td>
          <td class="amount">${savedAmt.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
        total += savedAmt;
      });

      document.getElementById('totalAmount').textContent = `Total Order Amount: PHP ${total.toFixed(2)}`;
    }

    function updateOrder(input, key, price) {
      const qty = parseInt(input.value) || 0;
      const amount = qty * price;
      const row = input.closest('tr');
      row.querySelector('.amount').textContent = amount.toFixed(2);

      if (qty > 0) {
        row.classList.add('highlight-order');
        orderData[key] = { qty, amount };
      } else {
        row.classList.remove('highlight-order');
        delete orderData[key];
      }
      updateTotalAmount();
    }

    function updateTotalAmount() {
      let total = 0;
      document.querySelectorAll('.amount').forEach(cell => {
        total += parseFloat(cell.textContent);
      });
      document.getElementById('totalAmount').textContent = `Total Order Amount: PHP ${total.toFixed(2)}`;
    }

    function submitOrders() {
      const orders = Object.entries(orderData).map(([barcode, data]) => {
        const row = [...document.querySelectorAll('#tableBody tr')].find(r => r.children[0].textContent === barcode);
        return {
          barcode,
          name: row.children[1].textContent,
          supplier: row.children[3].textContent,
          qty: data.qty,
          amount: data.amount
        };
      });

      if (orders.length === 0) return alert('No orders to submit.');
      google.script.run.savePurchaseOrders(orders);
      alert('Orders submitted successfully!');
    }

    function downloadCSV() {
      const now = new Date();
      const filename = `PO_${now.toISOString().split('T')[0]}.csv`;
      const rows = [['Date', 'Barcode', 'Item Name', '', 'Supplier', 'Purchase Price', 'Order Quantity', 'Total Order Amount']];
      const timestamp = now.toLocaleString();

      Object.entries(orderData).forEach(([barcode, data]) => {
        const row = [...document.querySelectorAll('#tableBody tr')].find(r => r.children[0].textContent === barcode);
        const price = parseFloat(row.children[4].textContent);
        rows.push([
          timestamp,
          `="${barcode}"`,
          row.children[1].textContent,
          '',
          row.children[3].textContent,
          price.toFixed(2),
          data.qty,
          data.amount.toFixed(2)
        ]);
      });

      const csv = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    // Initial load
    setMode('inventory');
  </script>
</body>
</html>
