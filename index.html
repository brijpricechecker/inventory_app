<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory & PO Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .controls { margin-bottom: 10px; }
    .checkbox-dropdown { position: relative; display: inline-block; }
    .checkbox-dropdown-content {
      display: none; position: absolute; background: #fff; border: 1px solid #ccc;
      max-height: 200px; overflow-y: auto; z-index: 999;
    }
    .checkbox-dropdown.open .checkbox-dropdown-content { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
    .highlight { background-color: #ffeeba; }
    button { margin-right: 10px; }
  </style>
</head>
<body>
  <div class="controls">
    <button onclick="switchMode(false)">Inventory View</button>
    <button onclick="switchMode(true)">Purchase Order</button>
    <button onclick="exportCSV()">Export CSV</button>

    <div class="checkbox-dropdown" id="supplierDropdown">
      <button onclick="toggleDropdown()">Select Supplier(s)</button>
      <div class="checkbox-dropdown-content" id="supplierList"></div>
    </div>
  </div>

  <table id="itemTable"></table>

  <script>
    let allItems = [];
    let allSuppliers = [];
    let selectedSuppliers = [];
    let isPO = false;
    const orderData = {};

    function switchMode(po) {
      isPO = po;
      fetchData();
    }

    function toggleDropdown() {
      document.getElementById("supplierDropdown").classList.toggle("open");
    }

    function fetchData() {
      const mode = isPO ? "po" : "inventory";
      const params = selectedSuppliers.length > 0
        ? `&suppliers=${selectedSuppliers.map(s => encodeURIComponent(s.toLowerCase())).join(",")}`
        : "";

      fetch(`https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec?mode=${mode}${params}`)
        .then(res => res.json())
        .then(data => {
          allItems = data.items;
          allSuppliers = data.suppliers;
          if (selectedSuppliers.length === 0) selectedSuppliers = [...allSuppliers];
          renderSupplierDropdown();
          renderTable();
        });
    }

    function renderSupplierDropdown() {
      const container = document.getElementById("supplierList");
      container.innerHTML = "";

      const selectAll = document.createElement("div");
      selectAll.innerHTML = `<label><input type="checkbox" id="selectAllBox"> Select All</label>`;
      container.appendChild(selectAll);

      document.getElementById("selectAllBox").addEventListener("change", e => {
        selectedSuppliers = e.target.checked ? [...allSuppliers] : [];
        renderSupplierDropdown();
        fetchData();
      });

      allSuppliers.forEach(supplier => {
        const checkbox = document.createElement("div");
        const checked = selectedSuppliers.includes(supplier);
        checkbox.innerHTML = `<label><input type="checkbox" value="${supplier}" ${checked ? "checked" : ""}> ${supplier}</label>`;
        container.appendChild(checkbox);
      });

      container.querySelectorAll("input[type=checkbox]").forEach(input => {
        if (input.id !== "selectAllBox") {
          input.addEventListener("change", () => {
            const value = input.value;
            if (input.checked && !selectedSuppliers.includes(value)) {
              selectedSuppliers.push(value);
            } else if (!input.checked) {
              selectedSuppliers = selectedSuppliers.filter(s => s !== value);
            }
            fetchData();
          });
        }
      });

      document.getElementById("selectAllBox").checked = selectedSuppliers.length === allSuppliers.length;
    }

    function renderTable() {
      const table = document.getElementById("itemTable");
      let html = "<tr><th>Barcode</th><th>Item Name</th><th>Supplier</th><th>Purchase Price</th>";

      if (isPO) {
        html += "<th>Order Qty</th><th>Order Amount</th>";
      } else {
        html += "<th>Current Inventory</th>";
      }
      html += "</tr>";

      allItems.forEach(item => {
        const barcode = item.barcode;
        const pp = isPO ? (item.altPurchasePrice || item.purchasePrice) : item.purchasePrice;
        const qty = orderData[barcode]?.qty || 0;
        const amt = qty * pp;

        html += `<tr${qty > 0 ? ' class="highlight"' : ""}>`;
        html += `<td>${item.barcode}</td><td>${item.name}</td><td>${item.supplier1}</td><td>${pp.toFixed(2)}</td>`;

        if (isPO) {
          html += `<td><input type="number" min="0" value="${qty}" onchange="updateQty('${barcode}', this.value, ${pp})" style="width: 80px;"></td>`;
          html += `<td>${amt.toFixed(2)}</td>`;
        } else {
          html += `<td>${item.currentInventory}</td>`;
        }

        html += "</tr>";
      });

      table.innerHTML = html;
    }

    function updateQty(barcode, value, price) {
      const qty = parseFloat(value) || 0;
      orderData[barcode] = { qty, amount: qty * price };
      renderTable();
    }

    function exportCSV() {
      const now = new Date();
      const pad = n => n.toString().padStart(2, '0');
      const timestamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}`;
      const supplierName = selectedSuppliers.length === 1 ? selectedSuppliers[0] : "multiple";
      const filename = isPO ? `purchase_order_${supplierName}_${timestamp}.csv` : `inventory_${supplierName}_${timestamp}.csv`;

      let rows = [];
      if (isPO) {
        rows.push(["Barcode", "Item Name", "Supplier", "Purchase Price", "Order Qty", "Order Amount"]);
      } else {
        rows.push(["Barcode", "Item Name", "Supplier", "Purchase Price", "Current Inventory"]);
      }

      allItems.forEach(item => {
        const barcode = item.barcode;
        const pp = isPO ? (item.altPurchasePrice || item.purchasePrice) : item.purchasePrice;
        const base = [item.barcode, item.name, item.supplier1, pp.toFixed(2)];

        if (isPO) {
          const qty = orderData[barcode]?.qty || 0;
          if (qty > 0) {
            const amt = qty * pp;
            rows.push([...base, qty, amt.toFixed(2)]);
          }
        } else {
          rows.push([...base, item.currentInventory]);
        }
      });

      const csv = rows.map(r => r.join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Initial load
    window.onload = () => {
      switchMode(false);
    };
  </script>
</body>
</html>
