<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Inventory & Purchase Order</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; align-items: center; }
    .btn { padding: 6px 12px; border: 1px solid #ccc; background: #f0f0f0; cursor: pointer; }
    .btn.active { background-color: #007bff; color: #fff; border-color: #007bff; }
    .dropdown { position: relative; }
    .dropdown-content {
      position: absolute; background: #fff; border: 1px solid #ccc;
      padding: 10px; box-shadow: 0px 4px 8px rgba(0,0,0,0.1);
      display: none; z-index: 1; max-height: 300px; overflow-y: auto;
    }
    .dropdown.show .dropdown-content { display: block; }
    .dropdown-content label { display: block; margin: 5px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    .zero-inventory { background: #ffe5e5; }
    .highlight-order { background: #e6f7ff; }
    #totalAmountDisplay { font-weight: bold; margin-left: auto; }
  </style>
</head>
<body>
  <h1>Inventory & Purchase Order</h1>
  <div class="controls">
    <button id="modeToggle" class="btn" onclick="toggleMode()">Purchase Order</button>
    <div class="dropdown">
      <button class="btn" onclick="toggleSupplierDropdown()">Select Suppliers â–¼</button>
      <div class="dropdown-content" id="supplierList"></div>
    </div>
    <label id="altToggle" style="display: none;">
      <input type="checkbox" onchange="toggleAltSupplier()"> Use Alt Supplier
    </label>
    <button class="btn" onclick="exportCSV()">Export CSV</button>
    <span id="totalAmountDisplay" style="display: none;"></span>
  </div>

  <table>
    <thead><tr id="tableHeaders"></tr></thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    const apiUrl = 'https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec'; // Replace with your actual URL
    let allSuppliers = [], selectedSuppliers = [];
    let allItems = [], useAlt = false, isPO = true;

    function toggleMode() {
      isPO = !isPO;
      document.getElementById('modeToggle').textContent = isPO ? 'Inventory' : 'Purchase Order';
      document.getElementById('altToggle').style.display = isPO ? 'inline' : 'none';
      fetchData();
    }

    function toggleAltSupplier() {
      useAlt = !useAlt;
      renderTable();
    }

    function toggleSupplierDropdown() {
      document.querySelector('.dropdown').classList.toggle('show');
    }

    async function fetchData() {
      const suppliersParam = selectedSuppliers.length > 0 ? selectedSuppliers.map(encodeURIComponent).join(',') : '';
      const modeParam = isPO ? 'po' : 'inventory';
      const res = await fetch(`${apiUrl}?mode=${modeParam}&suppliers=${suppliersParam}`);
      const data = await res.json();
      allSuppliers = data.suppliers;
      if (selectedSuppliers.length === 0) selectedSuppliers = [...allSuppliers];
      allItems = data.items;
      renderSupplierDropdown();
      renderTable();
    }

    function renderSupplierDropdown() {
      const container = document.getElementById('supplierList');
      container.innerHTML = '';

      const allBox = document.createElement('input');
      allBox.type = 'checkbox';
      allBox.checked = selectedSuppliers.length === allSuppliers.length;
      allBox.onchange = () => {
        selectedSuppliers = allBox.checked ? [...allSuppliers] : [];
        renderSupplierDropdown();
        fetchData();
        document.querySelector('.dropdown').classList.remove('show');
      };
      container.appendChild(allBox);
      container.appendChild(document.createTextNode(' Select All'));

      allSuppliers.forEach(supplier => {
        const label = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = supplier;
        cb.checked = selectedSuppliers.includes(supplier);
        cb.onchange = () => {
          if (cb.checked) {
            if (!selectedSuppliers.includes(cb.value)) selectedSuppliers.push(cb.value);
          } else {
            selectedSuppliers = selectedSuppliers.filter(s => s !== cb.value);
          }
          fetchData();
          document.querySelector('.dropdown').classList.remove('show');
        };
        label.appendChild(cb);
        label.appendChild(document.createTextNode(' ' + supplier));
        container.appendChild(label);
      });
    }

    function renderTable() {
      const headers = isPO
        ? ['Barcode', 'Item Name', 'Supplier', 'Current Inventory', 'Order Qty', 'Order Amount']
        : ['Barcode', 'Item Name', 'Supplier', 'Purchase Price', 'Current Inventory', 'Inventory Amount'];

      const headerRow = document.getElementById('tableHeaders');
      const body = document.getElementById('tableBody');
      headerRow.innerHTML = '';
      body.innerHTML = '';
      document.getElementById('totalAmountDisplay').style.display = isPO ? 'inline' : 'none';

      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headerRow.appendChild(th);
      });

      let totalOrderAmount = 0;

      allItems.forEach(item => {
        const tr = document.createElement('tr');
        const supplier = useAlt ? item.altSupplier : item.supplier1;
        const price = useAlt ? item.altPurchasePrice : item.purchasePrice;

        if (!supplier || !selectedSuppliers.includes(supplier)) return;

        if (!isPO && item.currentInventory === 0) tr.classList.add('zero-inventory');

        let cells = [
          `<td>'${item.barcode}'</td>`,
          `<td>${item.name}</td>`,
          `<td>${supplier}</td>`
        ];

        if (!isPO) {
          const amount = price * item.currentInventory;
          cells.push(
            `<td>${price.toFixed(2)}</td>`,
            `<td>${item.currentInventory}</td>`,
            `<td>${amount.toFixed(2)}</td>`
          );
        } else {
          cells.push(`<td>${item.currentInventory}</td>`);
          const qtyInput = document.createElement('input');
          qtyInput.type = 'number';
          qtyInput.min = 0;
          qtyInput.value = item.orderQty || '';
          qtyInput.oninput = () => {
            item.orderQty = parseFloat(qtyInput.value) || 0;
            item.orderAmount = item.orderQty * price;
            amountCell.textContent = item.orderAmount.toFixed(2);
            tr.classList.toggle('highlight-order', item.orderQty > 0);
            calculateTotalAmount();
          };

          const qtyCell = document.createElement('td');
          qtyCell.appendChild(qtyInput);
          cells.push(qtyCell.outerHTML);

          const amountCell = document.createElement('td');
          amountCell.textContent = item.orderAmount ? item.orderAmount.toFixed(2) : '0.00';
          cells.push(amountCell.outerHTML);

          if (item.orderQty > 0) {
            tr.classList.add('highlight-order');
            totalOrderAmount += item.orderAmount || 0;
          }
        }

        tr.innerHTML = cells.join('');
        body.appendChild(tr);
      });

      if (isPO) {
        document.getElementById('totalAmountDisplay').textContent = `Total: PHP ${totalOrderAmount.toFixed(2)}`;
      }
    }

    function calculateTotalAmount() {
      let total = 0;
      allItems.forEach(item => {
        const price = useAlt ? item.altPurchasePrice : item.purchasePrice;
        if (item.orderQty && item.orderQty > 0) {
          total += item.orderQty * price;
        }
      });
      document.getElementById('totalAmountDisplay').textContent = `Total: PHP ${total.toFixed(2)}`;
    }

    function exportCSV() {
      const rows = [];
      const filename = `${isPO ? 'purchase_order' : 'inventory'}_${new Date().toISOString().replace(/[:.]/g, '-')}.csv`;

      if (!isPO) {
        rows.push(['Barcode', 'Item Name', 'Supplier', 'Purchase Price', 'Current Inventory', 'Inventory Amount']);
        allItems.forEach(item => {
          const supplier = useAlt ? item.altSupplier : item.supplier1;
          const price = useAlt ? item.altPurchasePrice : item.purchasePrice;
          if (!supplier || !selectedSuppliers.includes(supplier)) return;
          const invAmt = item.currentInventory * price;
          rows.push([`'${item.barcode}`, item.name, supplier, price, item.currentInventory, invAmt.toFixed(2)]);
        });
      } else {
        rows.push(['Barcode', 'Item Name', 'Supplier', 'Current Inventory', 'Order Qty', 'Order Amount']);
        allItems.forEach(item => {
          const supplier = useAlt ? item.altSupplier : item.supplier1;
          const price = useAlt ? item.altPurchasePrice : item.purchasePrice;
          if (!supplier || !selectedSuppliers.includes(supplier)) return;
          if (item.orderQty > 0) {
            rows.push([`'${item.barcode}`, item.name, supplier, item.currentInventory, item.orderQty, (item.orderQty * price).toFixed(2)]);
          }
        });
      }

      const csv = rows.map(row => row.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    window.onload = fetchData;
    window.onclick = e => {
      if (!e.target.closest('.dropdown')) {
        document.querySelector('.dropdown')?.classList.remove('show');
      }
    };
  </script>
</body>
</html>
