<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Inventory & PO</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #f0f0f0; cursor: pointer; }
    .highlight { background-color: #ffffcc; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content {
      display: none;
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      z-index: 99;
      max-height: 200px;
      overflow-y: auto;
    }
    .dropdown:hover .dropdown-content { display: block; }
    .total-order {
      font-weight: bold;
      font-size: 1.1em;
      text-align: right;
    }
    button { margin-right: 8px; }
  </style>
</head>
<body>

<div style="display: flex; justify-content: space-between; align-items: center;">
  <div id="controls" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
    <button id="modeToggle">Switch to Purchase Order</button>
    <button id="altToggle" style="display:none;">Use Alt Supplier</button>

    <div class="dropdown">
      <button>Filter Suppliers ▼</button>
      <div class="dropdown-content" id="supplierFilter"></div>
    </div>

    <button id="downloadBtn">Export to CSV</button>
    <button id="submitBtn" style="display:none;">Submit Order</button>
  </div>
  <div id="totalOrder" class="total-order" style="display:none;"></div>
</div>

<div id="tableContainer"></div>

<script>
  const apiUrl = 'https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec'; // Replace with your Apps Script URL
  let allItems = [];
  let orderData = {};
  let selectedSuppliers = [];
  let isPO = false;
  let useAlt = false;
  let currentSort = { column: '', asc: true };

  document.getElementById('modeToggle').onclick = () => {
    isPO = !isPO;
    orderData = {};
    document.getElementById('modeToggle').textContent = isPO ? 'Switch to Inventory' : 'Switch to Purchase Order';
    document.getElementById('submitBtn').style.display = isPO ? '' : 'none';
    document.getElementById('altToggle').style.display = isPO ? '' : 'none';
    document.getElementById('totalOrder').style.display = isPO ? '' : 'none';
    fetchData();
  };

  document.getElementById('altToggle').onclick = () => {
    useAlt = !useAlt;
    document.getElementById('altToggle').style.backgroundColor = useAlt ? '#d1eaff' : '';
    renderTable();
  };

  document.getElementById('downloadBtn').onclick = exportToCSV;

  document.getElementById('submitBtn').onclick = async () => {
    const orders = Object.values(orderData);
    if (orders.length === 0) return alert('No orders to submit.');
    await fetch(`${apiUrl}`, {
      method: 'POST',
      body: JSON.stringify({ orders }),
      headers: { 'Content-Type': 'application/json' }
    });
    alert('Orders submitted!');
    orderData = {};
    fetchData();
  };

  function updateSupplierFilter(suppliers) {
    const container = document.getElementById('supplierFilter');
    container.innerHTML = '';

    const selectAllId = 'chk_select_all';
    const selectAll = document.createElement('div');
    selectAll.innerHTML = `<label><input type="checkbox" id="${selectAllId}" checked /> Select All</label>`;
    container.appendChild(selectAll);

    suppliers.forEach(supplier => {
      const id = 'chk_' + supplier.replace(/\s+/g, '_');
      const div = document.createElement('div');
      div.innerHTML = `<label><input type="checkbox" id="${id}" checked /> ${supplier}</label>`;
      container.appendChild(div);
    });

    function updateSelected() {
      selectedSuppliers = suppliers.filter(s => {
        const chk = document.getElementById('chk_' + s.replace(/\s+/g, '_'));
        return chk && chk.checked;
      });
      fetchData();
    }

    document.getElementById(selectAllId).onchange = (e) => {
      const checked = e.target.checked;
      suppliers.forEach(s => {
        const chk = document.getElementById('chk_' + s.replace(/\s+/g, '_'));
        if (chk) chk.checked = checked;
      });
      updateSelected();
    };

    suppliers.forEach(s => {
      const chk = document.getElementById('chk_' + s.replace(/\s+/g, '_'));
      chk.onchange = () => {
        const allChecked = suppliers.every(sup => document.getElementById('chk_' + sup.replace(/\s+/g, '_')).checked);
        document.getElementById(selectAllId).checked = allChecked;
        updateSelected();
      };
    });

    selectedSuppliers = [...suppliers];
  }

  async function fetchData() {
    const suppliersParam = selectedSuppliers.map(s => encodeURIComponent(s)).join(',');
    const mode = isPO ? 'po' : 'inventory';
    const res = await fetch(`${apiUrl}?mode=${mode}&suppliers=${suppliersParam}`);
    const data = await res.json();
    allItems = data.items;
    updateSupplierFilter(data.suppliers);
    renderTable();
  }

  function toggleSort(column) {
    if (currentSort.column === column) {
      currentSort.asc = !currentSort.asc;
    } else {
      currentSort.column = column;
      currentSort.asc = true;
    }
    renderTable();
  }

  function renderTable() {
    const container = document.getElementById('tableContainer');
    if (allItems.length === 0) {
      container.innerHTML = '<p>No data found.</p>';
      return;
    }

    const sortedItems = [...allItems];
    if (currentSort.column === 'inventory') {
      sortedItems.sort((a, b) => {
        const valA = a.currentInventory || 0;
        const valB = b.currentInventory || 0;
        return currentSort.asc ? valA - valB : valB - valA;
      });
    }

    let html = `<table><thead><tr>
      <th>Barcode</th><th>Item Name</th><th>Supplier</th><th>Purchase Price</th>`;

    if (isPO) {
      html += `<th onclick="toggleSort('inventory')">Current Inventory &#x21C5;</th><th>Order Qty</th><th>Order Amount</th>`;
    } else {
      html += `<th onclick="toggleSort('inventory')">Inventory &#x21C5;</th><th>Value</th>`;
    }

    html += `</tr></thead><tbody>`;

    sortedItems.forEach(item => {
      const supplier = useAlt ? item.supplier2 : item.supplier1;
      const price = useAlt ? item.altPurchasePrice : item.purchasePrice;
      const inv = item.currentInventory || 0;
      const isOrdered = !!orderData[item.barcode];

      let row = `<tr${isPO && isOrdered ? ' class="highlight"' : ''}>`;
      row += `<td>'${item.barcode}</td>`;
      row += `<td>${item.name}</td>`;
      row += `<td>${supplier}</td>`;
      row += `<td>${price.toFixed(2)}</td>`;

      if (isPO) {
        const qty = orderData[item.barcode]?.qty || '';
        const amt = orderData[item.barcode]?.amount || 0;
        row += `<td>${inv}</td>`;
        row += `<td><input type="number" min="0" step="1" value="${qty}"
          onfocus="this.select()" oninput="captureQty('${item.barcode}', this.value, ${price})"
          onkeydown="event.stopPropagation();"></td>`;
        row += `<td>${amt ? amt.toFixed(2) : ''}</td>`;
      } else {
        row += `<td>${inv}</td>`;
        row += `<td>${(inv * price).toFixed(2)}</td>`;
      }

      row += `</tr>`;
      html += row;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
    updateTotal();
  }

  function updateTotal() {
    const total = Object.values(orderData).reduce((sum, o) => sum + o.amount, 0);
    document.getElementById('totalOrder').textContent = isPO ? `Total Order Amount: ₱${total.toFixed(2)}` : '';
  }

  let qtyTimeout;
  function captureQty(barcode, val, price) {
    clearTimeout(qtyTimeout);
    qtyTimeout = setTimeout(() => {
      const qty = parseInt(val);
      if (qty > 0) {
        const item = allItems.find(i => i.barcode === barcode);
        const supplier = useAlt ? item.supplier2 : item.supplier1;
        orderData[barcode] = {
          qty,
          amount: qty * price,
          barcode,
          name: item.name,
          supplier,
          purchasePrice: price
        };
      } else {
        delete orderData[barcode];
      }
      updateTotal();
      renderTable();
    }, 300);
  }

  function exportToCSV() {
    const rows = [];
    const today = new Date();
    const dateStr = today.toISOString().split('T')[0]; // yyyy-mm-dd
    const supplierStr = selectedSuppliers.length === 1 ? selectedSuppliers[0].replace(/\s+/g, '_') : 'multiple';
    const filename = isPO ? `PO_${dateStr}_${supplierStr}.csv` : `inventory_${dateStr}_${supplierStr}.csv`;

    if (isPO) {
      rows.push(['Timestamp', 'Barcode', 'Item Name', 'Remarks', 'Supplier', 'Purchase Price', 'Order Quantity', 'Order Amount']);
      Object.values(orderData).forEach(order => {
        rows.push([
          new Date().toLocaleString(),
          order.barcode,
          order.name,
          '',
          order.supplier,
          order.purchasePrice.toFixed(2),
          order.qty,
          order.amount.toFixed(2)
        ]);
      });
    } else {
      rows.push(['Barcode', 'Item Name', 'Supplier', 'Purchase Price', 'Inventory', 'Value']);
      allItems.forEach(item => {
        const supplier = useAlt ? item.supplier2 : item.supplier1;
        const price = useAlt ? item.altPurchasePrice : item.purchasePrice;
        const inv = item.currentInventory || 0;
        rows.push([
          item.barcode,
          item.name,
          supplier,
          price.toFixed(2),
          inv,
          (inv * price).toFixed(2)
        ]);
      });
    }

    const csv = rows.map(r => r.map(v => `"${v}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  fetchData();
</script>

</body>
</html>
