<!DOCTYPE html>
<html>
<head>
  <title>Inventory & Purchase Order</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .filter-box, .actions {
      margin-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: left;
    }
    .checkbox-dropdown {
      position: relative;
      display: inline-block;
    }
    .checkbox-menu {
      display: none;
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      z-index: 1000;
      max-height: 200px;
      overflow-y: auto;
    }
    .checkbox-menu label {
      display: block;
    }
  </style>
</head>
<body>
  <h2>Inventory & Purchase Order</h2>
  <div class="filter-box">
    <label>Supplier:</label>
    <div class="checkbox-dropdown">
      <button id="toggleSupplierDropdown">Select Supplier</button>
      <div id="supplierDropdown" class="checkbox-menu"></div>
    </div>
    <button id="toggleAlt">Use Alt Supplier</button>
  </div>
  <div class="actions">
    <button id="submitOrders">Submit Orders</button>
    <button id="downloadCSV">Download CSV</button>
  </div>
  <table id="inventoryTable">
    <thead>
      <tr>
        <th>Barcode</th>
        <th>Item Name</th>
        <th>Supplier</th>
        <th>Purchase Price</th>
        <th>Total Sold</th>
        <th>Current Inventory</th>
        <th>Order Qty</th>
        <th>Order Amount</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let inventoryData = [];
    let selectedSuppliers = new Set();
    let useAlt = false;

    function fetchInventory() {
      $.getJSON("https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec", data => {
        inventoryData = data.items;
        populateSupplierFilter(data.suppliers);
        renderTable();
      });
    }

    function populateSupplierFilter(suppliers) {
      const dropdown = $("#supplierDropdown").empty();
      dropdown.append(`<label><input type="checkbox" value="__all__" checked> Select All</label>`);
      suppliers.forEach(s => {
        dropdown.append(`<label><input type="checkbox" value="${s}" checked> ${s}</label>`);
        selectedSuppliers.add(s);
      });
    }

    function renderTable() {
      const tbody = $("#inventoryTable tbody").empty();
      inventoryData.forEach(item => {
        const supplierKey = useAlt ? item.altSupplier : item.supplier1;
        const price = useAlt ? item.altPurchasePrice : item.purchasePrice;
        if (!selectedSuppliers.has(item.supplier1)) return;

        const row = $(`
          <tr>
            <td>${item.barcode}</td>
            <td>${item.name}</td>
            <td>${supplierKey || ""}</td>
            <td class="price">${price}</td>
            <td>${item.totalSold}</td>
            <td>${item.currentInventory}</td>
            <td><input type="number" min="0" class="orderQty" style="width: 60px"></td>
            <td class="orderAmt">0</td>
          </tr>
        `);
        row.find(".orderQty").on("input", function() {
          const qty = Number($(this).val()) || 0;
          const amt = qty * price;
          row.find(".orderAmt").text(amt.toFixed(2));
        });
        tbody.append(row);
      });
    }

    $(document).on("change", "#supplierDropdown input", function() {
      const val = $(this).val();
      if (val === "__all__") {
        const checked = $(this).prop("checked");
        $("#supplierDropdown input[type=checkbox]").prop("checked", checked);
        selectedSuppliers = new Set(checked ? inventoryData.map(i => i.supplier1) : []);
      } else {
        const checked = $(this).prop("checked");
        if (checked) selectedSuppliers.add(val);
        else selectedSuppliers.delete(val);

        // Update Select All
        const allChecked = $("#supplierDropdown input[type=checkbox]").not("[value='__all__']").length === selectedSuppliers.size;
        $("#supplierDropdown input[value='__all__']").prop("checked", allChecked);
      }
      renderTable();
      $("#supplierDropdown").hide();
    });

    $("#toggleSupplierDropdown").on("click", () => {
      $("#supplierDropdown").toggle();
    });

    $("#toggleAlt").on("click", () => {
      useAlt = !useAlt;
      $("#toggleAlt").text(useAlt ? "Using Alt Supplier" : "Use Alt Supplier");
      renderTable();
    });

    $("#submitOrders").on("click", () => {
      const orders = [];
      $("#inventoryTable tbody tr").each(function() {
        const qty = Number($(this).find(".orderQty").val());
        if (!qty) return;
        orders.push({
          barcode: $(this).find("td:eq(0)").text(),
          name: $(this).find("td:eq(1)").text(),
          supplier: $(this).find("td:eq(2)").text(),
          qty,
          amount: Number($(this).find(".orderAmt").text())
        });
      });
      if (orders.length === 0) return alert("No orders to submit");
      $.ajax({
        url: "https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({ orders }),
        success: () => alert("Orders submitted successfully")
      });
    });

    $("#downloadCSV").on("click", () => {
      let csv = "Barcode,Item Name,Supplier,Qty,Amount\n";
      let supplierName = "PO";
      $("#inventoryTable tbody tr").each(function() {
        const qty = Number($(this).find(".orderQty").val());
        if (!qty) return;
        const barcode = $(this).find("td:eq(0)").text();
        const name = $(this).find("td:eq(1)").text();
        const supplier = $(this).find("td:eq(2)").text();
        const amount = $(this).find(".orderAmt").text();
        supplierName = supplier || supplierName;
        csv += `${barcode},${name},${supplier},${qty},${amount}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const ts = new Date().toISOString().replace(/[:.-]/g, "").slice(0, 15);
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `PO_${supplierName}_${ts}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    fetchInventory();
  </script>
</body>
</html>
