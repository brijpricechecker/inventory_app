<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventory & PO Dashboard</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    .tab-button { padding: 8px 12px; margin-right: 10px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; }
    .tab-button.active { background-color: #007bff; color: white; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
    th { background-color: #f2f2f2; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content {
      display: none; position: absolute; background-color: #fff; border: 1px solid #ccc;
      z-index: 1; max-height: 200px; overflow-y: auto; padding: 5px;
    }
    .dropdown-content label { display: block; margin: 4px; }
    .dropdown:hover .dropdown-content { display: block; }
  </style>
</head>
<body>
  <h2>Inventory & Purchase Order</h2>

  <!-- Mode Selector -->
  <div>
    <span class="tab-button active" onclick="setMode('inventory')">Inventory</span>
    <span class="tab-button" onclick="setMode('purchase')">Purchase Order</span>
  </div>

  <!-- Supplier Filter -->
  <div style="margin: 15px 0;">
    <strong>Filter by Supplier:</strong>
    <div class="dropdown">
      <button>Select Suppliers</button>
      <div class="dropdown-content" id="supplierDropdown"></div>
    </div>
  </div>

  <!-- Inventory Table -->
  <table id="dataTable">
    <thead>
      <tr>
        <th>Barcode</th>
        <th>Item Name</th>
        <th>Supplier</th>
        <th>Use Alt Supplier?</th>
        <th>Current Inventory</th>
        <th>Purchase Price</th>
        <th class="po-only">Select</th>
        <th class="po-only">Order Qty</th>
        <th class="po-only">Order Amount</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec";

    let allData = [];
    let selectedSuppliers = new Set();
    let mode = "inventory";

    function setMode(newMode) {
      mode = newMode;
      document.querySelectorAll(".tab-button").forEach(btn => {
        btn.classList.remove("active");
        if (btn.textContent.toLowerCase().includes(newMode)) {
          btn.classList.add("active");
        }
      });
      updateTable();
    }

    function fetchData() {
      fetch(`${API_URL}?mode=all`)
        .then(res => res.json())
        .then(data => {
          allData = data;
          populateSupplierFilter(data);
          updateTable();
        })
        .catch(err => console.error("Data fetch error:", err));
    }

    function populateSupplierFilter(data) {
      const supplierSet = new Set(data.map(d => d.mainSupplier).filter(Boolean));
      const dropdown = document.getElementById("supplierDropdown");
      dropdown.innerHTML = `
        <label><input type="checkbox" id="selectAll" checked> Select All</label>
      `;
      supplierSet.forEach(supplier => {
        dropdown.innerHTML += `
          <label>
            <input type="checkbox" class="supplierOption" value="${supplier}" checked>
            ${supplier}
          </label>
        `;
      });
      selectedSuppliers = new Set(supplierSet);

      // Add event listeners
      dropdown.querySelectorAll("input").forEach(input => {
        input.addEventListener("change", () => {
          if (input.id === "selectAll") {
            const checked = input.checked;
            document.querySelectorAll(".supplierOption").forEach(opt => {
              opt.checked = checked;
              if (checked) selectedSuppliers.add(opt.value);
              else selectedSuppliers.delete(opt.value);
            });
          } else {
            const val = input.value;
            input.checked ? selectedSuppliers.add(val) : selectedSuppliers.delete(val);
            const allOptions = document.querySelectorAll(".supplierOption");
            document.getElementById("selectAll").checked = [...allOptions].every(opt => opt.checked);
          }

          // Close dropdown after selection
          setTimeout(() => {
            dropdown.parentElement.querySelector(".dropdown-content").style.display = "none";
          }, 100);
          updateTable();
        });
      });
    }

    function updateTable() {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";

      const showPO = mode === "purchase";
      document.querySelectorAll(".po-only").forEach(el => {
        el.style.display = showPO ? "" : "none";
      });

      allData.forEach((item, index) => {
        if (!selectedSuppliers.has(item.mainSupplier)) return;

        const row = document.createElement("tr");

        row.innerHTML = `
          <td>${item.barcode}</td>
          <td>${item.name}</td>
          <td class="supplierCell">${item.mainSupplier}</td>
          <td><input type="checkbox" class="altToggle" data-index="${index}"></td>
          <td>${item.currentInventory}</td>
          <td class="priceCell">${item.purchasePrice}</td>
          <td class="po-only"><input type="checkbox" class="selectBox" data-index="${index}"></td>
          <td class="po-only"><input type="number" class="qtyInput" value="0" min="1" data-index="${index}"></td>
          <td class="po-only orderAmt" id="orderAmt-${index}">0</td>
        `;

        tbody.appendChild(row);
      });

      bindRowEvents();
    }

    function bindRowEvents() {
      document.querySelectorAll(".altToggle").forEach(toggle => {
        toggle.addEventListener("change", () => {
          const index = toggle.dataset.index;
          const item = allData[index];
          const row = toggle.closest("tr");

          if (toggle.checked) {
            row.querySelector(".supplierCell").textContent = item.altSupplier || item.mainSupplier;
            row.querySelector(".priceCell").textContent = item.altPurchasePrice || item.purchasePrice;
          } else {
            row.querySelector(".supplierCell").textContent = item.mainSupplier;
            row.querySelector(".priceCell").textContent = item.purchasePrice;
          }

          updateOrderAmount(index, row);
        });
      });

      document.querySelectorAll(".selectBox").forEach(box => {
        box.addEventListener("change", () => {
          const index = box.dataset.index;
          const qtyInput = document.querySelector(`.qtyInput[data-index="${index}"]`);
          if (box.checked && qtyInput.value === "0") {
            qtyInput.value = "1";
          }
          updateOrderAmount(index);
        });
      });

      document.querySelectorAll(".qtyInput").forEach(input => {
        input.addEventListener("input", () => {
          const index = input.dataset.index;
          updateOrderAmount(index);
        });
      });
    }

    function updateOrderAmount(index, row = null) {
      row = row || document.querySelector(`.qtyInput[data-index="${index}"]`).closest("tr");
      const qty = parseFloat(row.querySelector(".qtyInput").value) || 0;
      const price = parseFloat(row.querySelector(".priceCell").textContent) || 0;
      const total = qty * price;
      document.getElementById(`orderAmt-${index}`).textContent = total.toFixed(2);
    }

    // Initial load
    fetchData();
  </script>
</body>
</html>

