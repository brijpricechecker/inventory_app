<!DOCTYPE html>
<html>
<head>
  <title>Inventory & Purchase Order</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .left-controls, .right-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .highlight-zero {
      background-color: #ffe5e5;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    #totalAmountCell {
      font-weight: bold;
      margin-top: 10px;
    }
    #supplierFilterPopup {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      z-index: 100;
    }
    #loadPOItems {
      display: none;
    }
  </style>
</head>
<body>
  <div class="controls">
    <div class="left-controls">
      <button onclick="switchToInventory()">Inventory</button>
      <button onclick="switchToPO()">Purchase Order</button>
      <button onclick="toggleAltSupplier()">Use Alt Supplier</button>
      <button onclick="toggleSupplierFilter()">Select Suppliers</button>
      <button id="loadPOItems" onclick="loadPOItems()">Load Items</button>
      <button onclick="submitOrders()">Submit Orders</button>
      <button onclick="downloadCSV()">Download CSV</button>
    </div>
    <div class="right-controls">
      <input type="text" id="searchBar" placeholder="Search by name or barcode" onkeyup="renderTable()">
    </div>
  </div>

  <div id="supplierFilterPopup"></div>
  <div id="totalAmountCell">Total Order Amount: PHP 0.00</div>
  <table>
    <thead>
      <tr id="tableHeader"></tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    const apiUrl = 'https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec';
    let allItems = [];
    let filteredItems = [];
    let allSuppliers = [];
    let selectedSuppliers = [];
    let useAlt = false;
    let isPOView = false;

    document.addEventListener('click', e => {
      if (!document.getElementById('supplierFilterPopup').contains(e.target) &&
          e.target.innerText !== 'Select Suppliers') {
        document.getElementById('supplierFilterPopup').style.display = 'none';
      }
    });

    async function fetchInitialData() {
      const res = await fetch(`${apiUrl}?mode=inventory`);
      const data = await res.json();
      allItems = data.items;
      allSuppliers = data.suppliers;
      selectedSuppliers = [...allSuppliers];
      renderSupplierFilter();
      renderTable();
    }

    async function loadPOItems() {
      const res = await fetch(`${apiUrl}?mode=po&suppliers=${encodeURIComponent(selectedSuppliers.join(','))}`);
      const data = await res.json();
      allItems = data.items;
      renderTable();
    }

    function switchToInventory() {
      isPOView = false;
      document.getElementById('loadPOItems').style.display = 'none';
      fetchInitialData();
    }

    function switchToPO() {
      isPOView = true;
      allItems = [];
      renderTable(); // clear
      document.getElementById('loadPOItems').style.display = 'inline-block';
    }

    function toggleAltSupplier() {
      useAlt = !useAlt;
      renderTable();
    }

    function toggleSupplierFilter() {
      const popup = document.getElementById('supplierFilterPopup');
      popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
      renderSupplierFilter();
    }

    function renderSupplierFilter() {
      const popup = document.getElementById('supplierFilterPopup');
      popup.innerHTML = '';

      const selectAll = document.createElement('div');
      const selectAllBox = document.createElement('input');
      selectAllBox.type = 'checkbox';
      selectAllBox.checked = selectedSuppliers.length === allSuppliers.length;
      selectAllBox.onclick = () => {
        selectedSuppliers = selectAllBox.checked ? [...allSuppliers] : [];
        renderSupplierFilter();
        renderTable();
      };
      selectAll.appendChild(selectAllBox);
      selectAll.appendChild(document.createTextNode(' Select All'));
      popup.appendChild(selectAll);

      allSuppliers.forEach(supplier => {
        const div = document.createElement('div');
        const box = document.createElement('input');
        box.type = 'checkbox';
        box.value = supplier;
        box.checked = selectedSuppliers.includes(supplier);
        box.onclick = () => {
          if (box.checked) {
            if (!selectedSuppliers.includes(supplier)) selectedSuppliers.push(supplier);
          } else {
            selectedSuppliers = selectedSuppliers.filter(s => s !== supplier);
          }
          renderSupplierFilter();
          renderTable();
        };
        div.appendChild(box);
        div.appendChild(document.createTextNode(' ' + supplier));
        popup.appendChild(div);
      });

      popup.style.display = 'block';
    }

    function renderTable() {
      const searchQuery = document.getElementById('searchBar').value.toLowerCase();
      const tbody = document.getElementById('tableBody');
      const thead = document.getElementById('tableHeader');
      tbody.innerHTML = '';
      thead.innerHTML = '';

      const visibleItems = allItems.filter(item => {
        const supplier = useAlt ? item.supplier2 || item.supplier1 : item.supplier1;
        const supplierMatch = selectedSuppliers.includes(supplier);
        const searchMatch = item.name.toLowerCase().includes(searchQuery) ||
                            item.barcode.toLowerCase().includes(searchQuery);
        return supplierMatch && searchMatch;
      });

      const headers = isPOView
        ? ['Barcode', 'Item Name', 'Supplier', 'Purchase Price', 'Order Quantity', 'Order Amount']
        : ['Barcode', 'Item Name', 'Current Inventory', 'Supplier', 'Purchase Price', 'Inventory Value'];

      headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        thead.appendChild(th);
      });

      visibleItems.forEach(item => {
        const supplier = useAlt ? item.supplier2 || item.supplier1 : item.supplier1;
        const price = useAlt ? item.altPurchasePrice || item.purchasePrice : item.purchasePrice;
        const tr = document.createElement('tr');

        if (!isPOView && item.currentInventory === 0) tr.classList.add('highlight-zero');

        if (isPOView) {
          tr.innerHTML = `
            <td>${item.barcode}</td>
            <td>${item.name}</td>
            <td>${supplier}</td>
            <td>${price.toFixed(2)}</td>
            <td><input type="number" min="0" value="0" onchange="updateAmount(this)"></td>
            <td class="amount">0.00</td>
          `;
        } else {
          const value = item.currentInventory * price;
          tr.innerHTML = `
            <td>${item.barcode}</td>
            <td>${item.name}</td>
            <td>${item.currentInventory}</td>
            <td>${supplier}</td>
            <td>${price.toFixed(2)}</td>
            <td>${value.toFixed(2)}</td>
          `;
        }

        tbody.appendChild(tr);
      });

      updateTotalAmount();
    }

    function updateAmount(input) {
      const row = input.closest('tr');
      const price = parseFloat(row.children[3].textContent);
      const qty = parseInt(input.value) || 0;
      const amount = price * qty;
      row.querySelector('.amount').textContent = amount.toFixed(2);
      updateTotalAmount();
    }

    function updateTotalAmount() {
      let total = 0;
      document.querySelectorAll('#tableBody .amount').forEach(cell => {
        total += parseFloat(cell.textContent);
      });
      document.getElementById('totalAmountCell').textContent = `Total Order Amount: PHP ${total.toFixed(2)}`;
    }

    function submitOrders() {
      const orders = [];
      document.querySelectorAll('#tableBody tr').forEach(row => {
        const qtyInput = row.children[4]?.querySelector('input');
        const qty = qtyInput ? parseInt(qtyInput.value) : 0;
        if (qty > 0) {
          orders.push({
            barcode: row.children[0].textContent,
            name: row.children[1].textContent,
            supplier: row.children[2].textContent,
            qty,
            amount: parseFloat(row.children[5].textContent)
          });
        }
      });
      if (orders.length === 0) return alert('No orders to submit.');
      google.script.run.savePurchaseOrders(orders);
      alert('Orders submitted successfully!');
    }

    function downloadCSV() {
      const rows = [['Date', 'Barcode', 'Item Name', '', 'Supplier', 'Purchase Price', 'Order Quantity', 'Total Order Amount']];
      const now = new Date();
      const timestamp = `${now.getMonth() + 1}/${now.getDate()}/${now.getFullYear()} ${now.toLocaleTimeString('en-US', { hour12: false })}`;
      let supplierForFile = selectedSuppliers.length === 1 ? selectedSuppliers[0] : 'Multiple';
      let filename = `PO_${supplierForFile}_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${now.getHours()}-${now.getMinutes()}.csv`;

      document.querySelectorAll('#tableBody tr').forEach(row => {
        const qtyInput = row.children[4]?.querySelector('input');
        const qty = qtyInput ? Number(qtyInput.value) : 0;
        const price = parseFloat(row.children[3].textContent) || 0;
        const total = qty * price;
        if (qty > 0) {
          rows.push([
            timestamp,
            `="${row.children[0].textContent}"`,
            row.children[1].textContent,
            '',
            row.children[2].textContent,
            price.toFixed(2),
            qty,
            total.toFixed(2)
          ]);
        }
      });

      const csvContent = rows.map(e => e.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.setAttribute('href', URL.createObjectURL(blob));
      link.setAttribute('download', filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    fetchInitialData();
  </script>
</body>
</html>
