<!DOCTYPE html>
<html>
<head>
  <title>Purchase Order System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    .left-controls, .right-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .highlight-zero {
      background-color: #ffe5e5;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    #totalAmountCell {
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="controls">
    <div class="left-controls">
      <button onclick="toggleAltSupplier()">Use Alt Supplier</button>
      <div id="supplierFilter"></div>
      <button onclick="submitOrders()">Submit Orders</button>
      <button onclick="downloadCSV()">Download CSV</button>
    </div>
    <div class="right-controls">
      <input type="text" id="searchBar" placeholder="Search by name or barcode" onkeyup="renderTable()">
    </div>
  </div>

  <div id="totalAmountCell">Total Order Amount: PHP 0.00</div>
  <table>
    <thead>
      <tr>
        <th>Barcode</th>
        <th>Item Name</th>
        <th>Current Inventory</th>
        <th>Supplier</th>
        <th>Purchase Price</th>
        <th>Order Quantity</th>
        <th>Order Amount</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    const apiUrl = 'https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec';
    let allItems = [];
    let selectedSuppliers = [];
    let useAlt = false;

    async function fetchData() {
      const res = await fetch(apiUrl);
      const data = await res.json();
      allItems = data.items.filter(item => item.totalSold !== 0 || item.totalPurchased !== 0);
      setupSupplierFilter(data.suppliers);
      selectedSuppliers = [...data.suppliers];
      renderTable();
    }

    function setupSupplierFilter(suppliers) {
      const container = document.getElementById('supplierFilter');
      container.innerHTML = '';
      const dropdown = document.createElement('select');
      dropdown.multiple = true;
      dropdown.size = Math.min(suppliers.length + 1, 10);

      const selectAllOption = document.createElement('option');
      selectAllOption.text = 'Select All';
      selectAllOption.onclick = () => {
        selectedSuppliers = [...suppliers];
        renderTable();
      };
      dropdown.appendChild(selectAllOption);

      suppliers.forEach(supplier => {
        const option = document.createElement('option');
        option.value = supplier;
        option.text = supplier;
        dropdown.appendChild(option);
      });

      dropdown.onchange = () => {
        selectedSuppliers = Array.from(dropdown.selectedOptions)
          .filter(opt => opt.value !== '')
          .map(opt => opt.value);
        renderTable();
      };

      container.appendChild(dropdown);
    }

    function toggleAltSupplier() {
      useAlt = !useAlt;
      renderTable();
    }

    function renderTable() {
      const searchQuery = document.getElementById('searchBar').value.toLowerCase();
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      let totalAmount = 0;

      allItems.forEach(item => {
        const mainSupplierMatch = selectedSuppliers.includes(item.supplier1);
        if (!mainSupplierMatch) return;

        if (searchQuery &&
            !item.name.toLowerCase().includes(searchQuery) &&
            !item.barcode.toLowerCase().includes(searchQuery)) return;

        const supplier = useAlt ? item.supplier2 || item.supplier1 : item.supplier1;
        const price = useAlt ? item.altPurchasePrice || item.purchasePrice : item.purchasePrice;

        const tr = document.createElement('tr');
        if (item.currentInventory === 0) tr.classList.add('highlight-zero');

        tr.innerHTML = `
          <td>${item.barcode}</td>
          <td>${item.name}</td>
          <td>${item.currentInventory}</td>
          <td>${supplier}</td>
          <td>${price.toFixed(2)}</td>
          <td><input type="number" min="0" value="0" onchange="updateAmount(this)"></td>
          <td class="amount">0.00</td>
        `;
        tbody.appendChild(tr);
      });

      updateTotalAmount();
    }

    function updateAmount(input) {
      const row = input.closest('tr');
      const price = parseFloat(row.children[4].textContent);
      const qty = parseInt(input.value) || 0;
      const amount = price * qty;
      row.querySelector('.amount').textContent = amount.toFixed(2);
      updateTotalAmount();
    }

    function updateTotalAmount() {
      let total = 0;
      document.querySelectorAll('#tableBody .amount').forEach(cell => {
        total += parseFloat(cell.textContent);
      });
      document.getElementById('totalAmountCell').textContent = `Total Order Amount: PHP ${total.toFixed(2)}`;
    }

    function submitOrders() {
      const orders = [];
      document.querySelectorAll('#tableBody tr').forEach(row => {
        const qty = parseInt(row.children[5].querySelector('input').value);
        if (qty > 0) {
          orders.push({
            barcode: row.children[0].textContent,
            name: row.children[1].textContent,
            supplier: row.children[3].textContent,
            qty,
            amount: parseFloat(row.children[6].textContent)
          });
        }
      });
      if (orders.length === 0) return alert('No orders to submit.');

      google.script.run.savePurchaseOrders(orders);
      alert('Orders submitted successfully!');
    }

    function downloadCSV() {
      const rows = [['Date', 'Barcode', 'Item Name', '', 'Supplier', 'Purchase Price', 'Order Quantity', 'Total Order Amount']];
      const now = new Date();
      const timestamp = `${now.getMonth() + 1}/${now.getDate()}/${now.getFullYear()} ${now.toLocaleTimeString('en-US', { hour12: false })}`;
      let supplierForFile = selectedSuppliers.length === 1 ? selectedSuppliers[0] : 'Multiple';
      let filename = `PO_${supplierForFile}_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${now.getHours()}-${now.getMinutes()}.csv`;

      document.querySelectorAll('#tableBody tr').forEach(row => {
        const cells = row.querySelectorAll('td');
        const qty = Number(cells[5].querySelector('input').value);
        const price = parseFloat(cells[4].textContent) || 0;
        const total = qty * price;
        if (qty > 0) {
          rows.push([
            timestamp,
            `="${cells[0].textContent}"`,
            cells[1].textContent,
            '',
            cells[3].textContent,
            price.toFixed(2),
            qty,
            total.toFixed(2)
          ]);
        }
      });

      const csvContent = rows.map(e => e.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.setAttribute('href', URL.createObjectURL(blob));
      link.setAttribute('download', filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    fetchData();
  </script>
</body>
</html>
