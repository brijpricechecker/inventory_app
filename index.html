<!DOCTYPE html>
<html>
<head>
  <title>Inventory & Purchase Dashboard</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    .highlight-zero {
      background-color: #ffe5e5; /* light red for 0 inventory */
    }
    button {
      margin: 10px 0;
      padding: 6px 12px;
    }
  </style>
</head>
<body>
  <h1>Dashboard</h1>
  <div>
    Mode:
    <select id="modeSelect">
      <option value="inventory">Inventory</option>
      <option value="po">Purchase Order</option>
    </select>
    <button onclick="loadData()">Load</button>
    <button onclick="downloadCSV()">Download CSV</button>
  </div>
  <div id="tableContainer"></div>

  <script>
    let currentData = [];
    let currentMode = 'inventory';

    function loadData() {
      currentMode = document.getElementById("modeSelect").value;

      fetch(`https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec?mode=${currentMode}`)
        .then(res => res.json())
        .then(data => {
          currentData = data.items || [];
          renderTable(currentData);
        });
    }

    function renderTable(data) {
      const container = document.getElementById("tableContainer");
      if (!data.length) return (container.innerHTML = "<p>No data found.</p>");

      let html = "<table><thead><tr>";
      const headers = Object.keys(data[0]);
      headers.forEach(h => html += `<th>${h}</th>`);
      html += "</tr></thead><tbody>";

      data.forEach(row => {
        const rowClass = row.highlight ? ' class="highlight-zero"' : '';
        html += `<tr${rowClass}>`;
        headers.forEach(h => html += `<td>${row[h]}</td>`);
        html += "</tr>";
      });

      html += "</tbody></table>";
      container.innerHTML = html;
    }

    function downloadCSV() {
      if (!currentData.length) return alert("No data to download.");

      let csvContent = '';
      const now = new Date().toLocaleString();

      if (currentMode === 'po') {
        csvContent += "Timestamp,Barcode,Item Name,,Supplier,Purchase Price,Ordered Qty,Ordered Amount\n";
        currentData.forEach(row => {
          csvContent += [
            now,
            `'${row.barcode}`, // barcode as text
            row.name,
            '',
            row.supplier,
            row.purchasePrice || 0,
            row.qty,
            row.amount
          ].join(",") + "\n";
        });
      } else {
        // Inventory mode â€“ export full data
        const headers = Object.keys(currentData[0]);
        csvContent += headers.join(",") + "\n";
        currentData.forEach(row => {
          csvContent += headers.map(h => {
            if (h.toLowerCase() === 'barcode') return `'${row[h]}`;
            return row[h];
          }).join(",") + "\n";
        });
      }

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `${currentMode}_data_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Auto-load on page load
    window.onload = loadData;
  </script>
</body>
</html>
