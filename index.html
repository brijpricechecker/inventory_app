<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Inventory & Purchase Order</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
    h1 { font-size: 24px; }
    .controls { margin-bottom: 10px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content {
      display: none; position: absolute; background-color: #fff; min-width: 200px;
      box-shadow: 0px 4px 8px rgba(0,0,0,0.1); padding: 10px; z-index: 1;
      max-height: 300px; overflow-y: auto; border: 1px solid #ccc;
    }
    .dropdown-content label { display: block; margin: 5px 0; }
    .dropdown-content input[type="checkbox"] { margin-right: 5px; }
    .dropdown.show .dropdown-content { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th.sortable { cursor: pointer; }
    .zero-inventory { background-color: #ffe5e5; } /* light red */
    .btn { padding: 6px 12px; cursor: pointer; border: 1px solid #ccc; background: #f0f0f0; }
    #totalAmountDisplay { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Inventory & Purchase Order</h1>
  <div class="controls">
    <button class="btn" onclick="setMode('inventory')">Inventory</button>
    <button class="btn" onclick="setMode('po')">Purchase Order</button>
    
    <div class="dropdown">
      <button class="btn" onclick="toggleDropdown()">Select Suppliers â–¼</button>
      <div class="dropdown-content" id="supplierList"></div>
    </div>
    
    <button class="btn" onclick="exportCSV()">Export CSV</button>
    <span id="totalAmountDisplay" style="display:none;"></span>
  </div>

  <table id="itemTable">
    <thead>
      <tr id="tableHeaders"></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let mode = 'inventory';
    let allSuppliers = [];
    let selectedSuppliers = [];
    let currentItems = [];
    let inventorySortAsc = true;

    function setMode(newMode) {
      mode = newMode;
      document.getElementById('totalAmountDisplay').style.display = (mode === 'po') ? 'block' : 'none';
      fetchData();
    }

    function toggleDropdown() {
      document.getElementById('supplierList').parentElement.classList.toggle('show');
    }

    function renderSupplierDropdown() {
      const container = document.getElementById('supplierList');
      container.innerHTML = '';

      const allBox = document.createElement('input');
      allBox.type = 'checkbox';
      allBox.id = 'selectAllSuppliers';
      allBox.checked = selectedSuppliers.length === allSuppliers.length &&
                       allSuppliers.every(s => selectedSuppliers.includes(s));
      allBox.onchange = () => {
        if (allBox.checked) {
          selectedSuppliers = [...allSuppliers];
        } else {
          selectedSuppliers = [];
        }
        container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          if (cb !== allBox) cb.checked = allBox.checked;
        });
        fetchData();
        container.parentElement.classList.remove('show');
      };
      container.appendChild(allBox);
      container.appendChild(document.createTextNode(' Select All'));

      allSuppliers.forEach(supplier => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = supplier;
        checkbox.checked = selectedSuppliers.includes(supplier);
        checkbox.onchange = () => {
          if (checkbox.checked) {
            if (!selectedSuppliers.includes(supplier)) selectedSuppliers.push(supplier);
          } else {
            selectedSuppliers = selectedSuppliers.filter(s => s !== supplier);
          }
          document.getElementById('selectAllSuppliers').checked =
            selectedSuppliers.length === allSuppliers.length &&
            allSuppliers.every(s => selectedSuppliers.includes(s));
          fetchData();
          container.parentElement.classList.remove('show');
        };
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(' ' + supplier));
        container.appendChild(label);
      });
    }

    function fetchData() {
      const finalSuppliers = selectedSuppliers.length ? selectedSuppliers : allSuppliers;
      const params = new URLSearchParams();
      params.append('mode', mode);
      params.append('suppliers', finalSuppliers.join(','));

      fetch(`https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec?${params}`)
        .then(res => res.json())
        .then(data => {
          allSuppliers = data.suppliers;
          if (!selectedSuppliers.length || selectedSuppliers.some(s => !allSuppliers.includes(s))) {
            selectedSuppliers = [...allSuppliers];
          }
          currentItems = data.items;
          renderSupplierDropdown();
          renderTable();
        });
    }

    function renderTable() {
      const headersRow = document.getElementById('tableHeaders');
      const tbody = document.querySelector('#itemTable tbody');
      tbody.innerHTML = '';
      headersRow.innerHTML = '';

      const headers = mode === 'inventory' 
        ? ['Barcode', 'Item Name', 'Supplier', 'Current Inventory'] 
        : ['Barcode', 'Item Name', 'Supplier', 'Current Inventory', 'Order Qty', 'Order Amount'];

      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        if (h === 'Current Inventory') {
          th.classList.add('sortable');
          th.onclick = () => {
            inventorySortAsc = !inventorySortAsc;
            currentItems.sort((a, b) => inventorySortAsc ? a.currentInventory - b.currentInventory : b.currentInventory - a.currentInventory);
            renderTable();
          };
        }
        headersRow.appendChild(th);
      });

      const filteredItems = currentItems.filter(item =>
        selectedSuppliers.includes(item.supplier1)
      );

      let totalOrderAmount = 0;

      filteredItems.forEach(item => {
        const tr = document.createElement('tr');
        if (mode === 'inventory' && item.currentInventory === 0) tr.classList.add('zero-inventory');

        const supplierName = item.supplier1 || '';
        tr.innerHTML = `
          <td>${item.barcode}</td>
          <td>${item.name}</td>
          <td>${supplierName}</td>
          <td>${item.currentInventory}</td>
        `;

        if (mode === 'po') {
          const qtyInput = document.createElement('input');
          qtyInput.type = 'number';
          qtyInput.min = 0;
          qtyInput.value = item.orderQty || '';
          qtyInput.oninput = () => {
            item.orderQty = parseFloat(qtyInput.value) || 0;
            item.orderAmount = item.orderQty * item.purchasePrice;
            amountCell.textContent = item.orderAmount.toFixed(2);
            calculateTotalAmount();
          };

          const qtyCell = document.createElement('td');
          qtyCell.appendChild(qtyInput);
          tr.appendChild(qtyCell);

          const amountCell = document.createElement('td');
          amountCell.textContent = item.orderAmount ? item.orderAmount.toFixed(2) : '0.00';
          tr.appendChild(amountCell);

          if (item.orderQty && item.orderQty > 0) {
            tr.style.backgroundColor = '#e6f7ff';
            totalOrderAmount += item.orderAmount || 0;
          }
        }

        tbody.appendChild(tr);
      });

      document.getElementById('totalAmountDisplay').textContent = 
        (mode === 'po') ? `Total Order Amount: PHP ${totalOrderAmount.toFixed(2)}` : '';
    }

    function calculateTotalAmount() {
      let total = 0;
      currentItems.forEach(item => {
        if (item.orderQty && item.orderQty > 0) {
          item.orderAmount = item.orderQty * item.purchasePrice;
          total += item.orderAmount;
        }
      });
      document.getElementById('totalAmountDisplay').textContent = 
        `Total Order Amount: PHP ${total.toFixed(2)}`;
    }

    function exportCSV() {
      let rows = [];

      if (mode === 'inventory') {
        rows.push(['Barcode', 'Item Name', 'Supplier', 'Current Inventory']);
        currentItems.forEach(item => {
          if (selectedSuppliers.includes(item.supplier1)) {
            rows.push([item.barcode, item.name, item.supplier1, item.currentInventory]);
          }
        });
      } else {
        rows.push(['Barcode', 'Item Name', 'Supplier', 'Current Inventory', 'Order Qty', 'Order Amount']);
        currentItems.forEach(item => {
          if (selectedSuppliers.includes(item.supplier1) && item.orderQty > 0) {
            rows.push([
              item.barcode,
              item.name,
              item.supplier1,
              item.currentInventory,
              item.orderQty,
              (item.orderQty * item.purchasePrice).toFixed(2)
            ]);
          }
        });
      }

      const csvContent = rows.map(e => e.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);

      const now = new Date().toISOString().replace(/[:.]/g, '-');
      const supplierLabel = selectedSuppliers.length === 1 ? selectedSuppliers[0] : 'multiple';
      const filename = (mode === 'po' ? `purchase_order_${supplierLabel}_${now}.csv` : `inventory_${supplierLabel}_${now}.csv`);

      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    window.onload = fetchData;
    window.onclick = e => {
      if (!e.target.closest('.dropdown')) {
        document.querySelector('.dropdown').classList.remove('show');
      }
    };
  </script>
</body>
</html>
