<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory & Purchase Order</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 10px;
    }
    .left-controls, .right-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    .highlight-order {
      background-color: #e0ffe0;
    }
    .highlight-zero {
      background-color: #ffe5e5;
    }
    .dropdown {
      position: relative;
    }
    .dropdown-content {
      position: absolute;
      background-color: white;
      border: 1px solid #ccc;
      z-index: 10;
      padding: 10px;
      display: none;
      max-height: 200px;
      overflow-y: auto;
    }
    .dropdown-content label {
      display: block;
    }
    .show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="controls">
    <div class="left-controls">
      <button onclick="toggleMode()" id="modeToggle">Purchase Order</button>
      <button onclick="toggleAltSupplier()">Use Alt Supplier</button>
      <div class="dropdown" id="supplierDropdown">
        <button onclick="toggleSupplierDropdown()">Select Suppliers</button>
        <div class="dropdown-content" id="supplierList"></div>
      </div>
      <button onclick="submitOrders()">Submit Orders</button>
      <button onclick="downloadCSV()">Download CSV</button>
    </div>
    <div class="right-controls">
      <input type="text" id="searchBar" placeholder="Search by name or barcode" onkeyup="renderTable()">
    </div>
  </div>

  <div id="totalAmountCell">Total Order Amount: PHP 0.00</div>

  <table>
    <thead>
      <tr id="tableHeader"></tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    const apiUrl = 'https://script.google.com/macros/s/AKfycbwA2KDBI3mwXx8mn6n5ICO5tVAexOCRxHGr2IwXnWwvifmHY6-lhX4wB-6NDsQ_ppg/exec';
    let allItems = [];
    let selectedSuppliers = [];
    let allSuppliers = [];
    let useAlt = false;
    let isPO = false;
    let orderData = {};

    window.onload = async () => {
      const res = await fetch(`${apiUrl}?mode=suppliersOnly`);
      const data = await res.json();
      allSuppliers = data.suppliers;
      selectedSuppliers = [...allSuppliers];
      renderSupplierDropdown();
      fetchData(true);
    };

    function toggleMode() {
      isPO = !isPO;
      document.getElementById("modeToggle").textContent = isPO ? "Inventory" : "Purchase Order";
      allItems = [];
      orderData = {};
      selectedSuppliers = isPO ? [] : [...allSuppliers];
      document.getElementById("totalAmountCell").style.display = isPO ? "block" : "none";
      fetchData(!isPO);
    }

    function toggleAltSupplier() {
      useAlt = !useAlt;
      renderTable();
    }

    function toggleSupplierDropdown() {
      document.getElementById("supplierList").classList.toggle("show");
    }

    function renderSupplierDropdown() {
      const container = document.getElementById("supplierList");
      container.innerHTML = "";

      const allBox = document.createElement("input");
      allBox.type = "checkbox";
      allBox.id = "selectAllSuppliers";
      allBox.checked = selectedSuppliers.length === allSuppliers.length;
      allBox.onchange = () => {
        selectedSuppliers = allBox.checked ? [...allSuppliers] : [];
        document.querySelectorAll("#supplierList input[type=checkbox]").forEach(cb => {
          if (cb.id !== "selectAllSuppliers") cb.checked = allBox.checked;
        });
        fetchData(!isPO);
      };

      const allLabel = document.createElement("label");
      allLabel.appendChild(allBox);
      allLabel.appendChild(document.createTextNode("Select All"));
      container.appendChild(allLabel);

      allSuppliers.forEach(supplier => {
        const label = document.createElement("label");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = supplier;
        checkbox.checked = selectedSuppliers.includes(supplier);
        checkbox.onchange = () => {
          if (checkbox.checked) {
            if (!selectedSuppliers.includes(supplier)) selectedSuppliers.push(supplier);
          } else {
            selectedSuppliers = selectedSuppliers.filter(s => s !== supplier);
          }
          allBox.checked = selectedSuppliers.length === allSuppliers.length;
          fetchData(!isPO);
        };
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(supplier));
        container.appendChild(label);
      });
    }

    async function fetchData(isInventoryMode) {
      if (!isInventoryMode && selectedSuppliers.length === 0) {
        allItems = [];
        renderTable();
        return;
      }

      const url = `${apiUrl}?mode=${isInventoryMode ? "inventory" : "po"}&suppliers=${encodeURIComponent(JSON.stringify(selectedSuppliers))}`;
      const res = await fetch(url);
      const data = await res.json();
      const newItems = data.items;

      if (!isInventoryMode && allItems.length > 0) {
        const existingBarcodes = new Set(allItems.map(i => i.barcode));
        const additional = newItems.filter(i => !existingBarcodes.has(i.barcode));
        allItems.push(...additional);
      } else {
        allItems = newItems;
      }

      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById("tableBody");
      const header = document.getElementById("tableHeader");
      tbody.innerHTML = "";
      header.innerHTML = "";

      const search = document.getElementById("searchBar").value.toLowerCase();

      const visibleItems = allItems
        .filter(item => (selectedSuppliers.includes(item.supplier1) || !isPO))
        .filter(item => item.name.toLowerCase().includes(search) || item.barcode.includes(search))
        .sort((a, b) => {
          const sA = (a.supplier1 || '').toLowerCase();
          const sB = (b.supplier1 || '').toLowerCase();
          if (sA !== sB) return sA.localeCompare(sB);
          return a.name.localeCompare(b.name);
        });

      const columns = ["Barcode", "Item Name", "Current Inventory", "Supplier", "Purchase Price"];
      if (isPO) {
        columns.push("Order Quantity", "Order Amount");
      } else {
        columns.push("Inventory Amount");
      }

      columns.forEach(col => {
        const th = document.createElement("th");
        th.textContent = col;
        header.appendChild(th);
      });

      visibleItems.forEach(item => {
        const tr = document.createElement("tr");
        const supplier = useAlt ? item.supplier2 || item.supplier1 : item.supplier1;
        const price = useAlt ? item.altPurchasePrice || item.purchasePrice : item.purchasePrice;
        const barcode = item.barcode;
        const qty = orderData[barcode]?.qty || 0;
        const amount = price * qty;
        const inventoryAmount = price * item.currentInventory;

        if (item.currentInventory === 0) tr.classList.add("highlight-zero");
        if (qty > 0) tr.classList.add("highlight-order");

        tr.innerHTML = `
          <td>${barcode}</td>
          <td>${item.name}</td>
          <td>${item.currentInventory}</td>
          <td>${supplier}</td>
          <td>${price.toFixed(2)}</td>
          ${isPO 
            ? `<td><input type="number" min="0" value="${qty}" onchange="updateQty(this, '${barcode}', ${price})"></td>
               <td class="amount">${amount.toFixed(2)}</td>`
            : `<td>${inventoryAmount.toFixed(2)}</td>`}
        `;
        tbody.appendChild(tr);
      });

      updateTotalAmount();
    }

    function updateQty(input, barcode, price) {
      const qty = parseInt(input.value) || 0;
      orderData[barcode] = { qty, amount: qty * price };
      renderTable();
    }

    function updateTotalAmount() {
      if (!isPO) return;
      let total = 0;
      Object.values(orderData).forEach(o => total += o.amount);
      document.getElementById("totalAmountCell").textContent = `Total Order Amount: PHP ${total.toFixed(2)}`;
    }

    function submitOrders() {
      const orders = Object.entries(orderData)
        .filter(([_, data]) => data.qty > 0)
        .map(([barcode, data]) => {
          const item = allItems.find(i => i.barcode === barcode);
          return {
            barcode,
            name: item.name,
            supplier: useAlt ? item.supplier2 || item.supplier1 : item.supplier1,
            qty: data.qty,
            amount: data.amount
          };
        });
      if (!orders.length) return alert("No orders to submit.");
      google.script.run.savePurchaseOrders(orders);
      alert("Orders submitted successfully!");
    }

    function downloadCSV() {
      const rows = [["Date", "Barcode", "Item Name", "", "Supplier", "Purchase Price", "Quantity", "Total Amount"]];
      const now = new Date();
      const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}-${String(now.getDate()).padStart(2, "0")}_${now.getHours()}-${now.getMinutes()}`;
      const supplierPart = selectedSuppliers.length === 1 ? selectedSuppliers[0].replace(/ /g, "_") : "multiple";
      const filename = isPO
        ? `purchase_order_${supplierPart}_${timestamp}.csv`
        : `inventory_${supplierPart}_${timestamp}.csv`;

      const data = isPO
        ? Object.entries(orderData).filter(([_, d]) => d.qty > 0).map(([barcode, d]) => {
            const item = allItems.find(i => i.barcode === barcode);
            const supplier = useAlt ? item.supplier2 || item.supplier1 : item.supplier1;
            const price = useAlt ? item.altPurchasePrice || item.purchasePrice : item.purchasePrice;
            return [
              now.toLocaleString(),
              `="${barcode}"`,
              item.name,
              "",
              supplier,
              price.toFixed(2),
              d.qty,
              d.amount.toFixed(2)
            ];
          })
        : allItems
            .filter(item => selectedSuppliers.includes(item.supplier1) || !isPO)
            .map(item => {
              const supplier = useAlt ? item.supplier2 || item.supplier1 : item.supplier1;
              const price = useAlt ? item.altPurchasePrice || item.purchasePrice : item.purchasePrice;
              const inventoryAmount = price * item.currentInventory;
              return [
                now.toLocaleString(),
                `="${item.barcode}"`,
                item.name,
                "",
                supplier,
                price.toFixed(2),
                item.currentInventory,
                inventoryAmount.toFixed(2)
              ];
            });

      if (!data.length) return alert("No data to export.");

      const csvContent = [rows[0], ...data].map(r => r.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.setAttribute("href", URL.createObjectURL(blob));
      link.setAttribute("download", filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
